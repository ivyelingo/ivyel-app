<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Elingo â€” IVYÂ·EL í•™ìŠµ ì•±</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Noto+Serif+KR:wght@300;400;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --cream: #FAF6F0;
  --warm: #FDF9F4;
  --sage: #8A9E8C;
  --sage-light: #C5D4C6;
  --rose: #C4998A;
  --rose-light: #E8D0C8;
  --gold: #C9A96E;
  --gold-light: #EDD9B0;
  --charcoal: #2C2C2C;
  --gray: #6B6B6B;
  --light: #E8E4DF;
  --navy: #2D3A4A;
  --success: #7BAE7F;
  --warning: #E5A847;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; }

body {
  background: var(--cream);
  font-family: 'DM Sans', 'Noto Serif KR', sans-serif;
  color: var(--charcoal);
  display: flex;
  flex-direction: column;
  max-width: 430px;
  margin: 0 auto;
  position: relative;
  box-shadow: 0 0 60px rgba(0,0,0,0.12);
}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 2rem;
  background: linear-gradient(160deg, var(--cream) 0%, #F0E8DC 100%);
}

.login-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.8rem;
  font-weight: 600;
  letter-spacing: 0.08em;
  margin-bottom: 0.3rem;
}
.login-logo span { color: var(--gold); }

.login-sub {
  font-size: 0.78rem;
  color: var(--gray);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-bottom: 3rem;
}

.role-select {
  width: 100%;
  margin-bottom: 2rem;
}

.role-label {
  font-size: 0.75rem;
  color: var(--gray);
  margin-bottom: 0.7rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.role-btns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.8rem;
}

.role-btn {
  padding: 1rem;
  border-radius: 16px;
  border: 2px solid var(--light);
  background: var(--warm);
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.role-btn.active {
  border-color: var(--gold);
  background: var(--gold-light);
}

.role-btn .role-icon { font-size: 1.6rem; display: block; margin-bottom: 0.3rem; }
.role-btn .role-name { font-size: 0.82rem; font-weight: 500; }

.login-form { width: 100%; }

.l-input {
  width: 100%;
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 12px;
  padding: 0.85rem 1rem;
  font-size: 0.9rem;
  font-family: 'DM Sans', sans-serif;
  outline: none;
  margin-bottom: 0.8rem;
  transition: border-color 0.2s;
}
.l-input:focus { border-color: var(--rose); }

.login-btn {
  width: 100%;
  background: var(--charcoal);
  color: var(--cream);
  border: none;
  border-radius: 100px;
  padding: 1rem;
  font-size: 0.9rem;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: background 0.2s;
  margin-top: 0.4rem;
}
.login-btn:hover { background: var(--rose); }

/* â”€â”€ MAIN APP â”€â”€ */
#app { display:none; flex-direction:column; height:100%; }
#app.show { display:flex; }

/* TOP BAR */
.topbar {
  background: var(--warm);
  border-bottom: 1px solid var(--light);
  padding: 1rem 1.2rem 0.8rem;
  flex-shrink: 0;
}

.topbar-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.topbar-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  font-weight: 600;
}
.topbar-logo span { color: var(--gold); }

.topbar-user {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.avatar {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--rose-light), var(--gold-light));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--charcoal);
}

.user-name { font-size: 0.82rem; font-weight: 500; }
.user-role {
  font-size: 0.65rem;
  color: var(--gray);
  background: var(--light);
  padding: 0.15rem 0.6rem;
  border-radius: 100px;
}

/* PAGE CONTENT */
.page-content {
  flex: 1;
  overflow-y: auto;
  padding: 1.2rem;
  -webkit-overflow-scrolling: touch;
}

/* BOTTOM NAV */
.bottom-nav {
  background: var(--warm);
  border-top: 1px solid var(--light);
  display: flex;
  padding: 0.6rem 0 0.8rem;
  flex-shrink: 0;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: 0.4rem 0;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  background: none;
}

.nav-icon { font-size: 1.3rem; }
.nav-label {
  font-size: 0.62rem;
  color: var(--gray);
  font-family: 'DM Sans', sans-serif;
  letter-spacing: 0.03em;
}

.nav-item.active .nav-label { color: var(--rose); font-weight: 600; }
.nav-item.active .nav-icon { transform: scale(1.1); }

/* â”€â”€ PAGES â”€â”€ */
.page { display: none; }
.page.active { display: block; }

/* Section title */
.sec-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
}
.sec-title em { font-style: italic; color: var(--rose); }

.sec-sub {
  font-size: 0.78rem;
  color: var(--gray);
  margin-bottom: 1.2rem;
  font-family: 'Noto Serif KR', serif;
  font-weight: 300;
}

/* Cards */
.card {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 18px;
  padding: 1.2rem;
  margin-bottom: 0.9rem;
  transition: all 0.2s;
}
.card:active { transform: scale(0.98); }

/* HOME */
.greeting {
  background: linear-gradient(135deg, var(--charcoal), var(--navy));
  border-radius: 20px;
  padding: 1.5rem;
  margin-bottom: 1.2rem;
  color: var(--cream);
  position: relative;
  overflow: hidden;
}

.greeting::before {
  content: '';
  position: absolute;
  width: 150px; height: 150px;
  background: rgba(201,169,110,0.15);
  border-radius: 50%;
  top: -40px; right: -30px;
}

.greeting-hello { font-size: 0.75rem; color: var(--gold-light); letter-spacing: 0.1em; margin-bottom: 0.3rem; }
.greeting-name { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 600; margin-bottom: 0.8rem; }
.greeting-name em { font-style: italic; color: var(--gold); }

.greeting-stats {
  display: flex;
  gap: 1.5rem;
}

.g-stat { text-align: center; }
.g-stat-num { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 600; color: var(--gold); }
.g-stat-label { font-size: 0.65rem; color: rgba(250,246,240,0.6); letter-spacing: 0.05em; }

/* Progress bar */
.progress-bar {
  height: 6px;
  background: var(--light);
  border-radius: 100px;
  overflow: hidden;
  margin: 0.5rem 0;
}
.progress-fill {
  height: 100%;
  border-radius: 100px;
  background: linear-gradient(90deg, var(--rose), var(--gold));
  transition: width 0.5s ease;
}

/* Quick actions */
.quick-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.8rem;
  margin-bottom: 1.2rem;
}

.quick-card {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 16px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.2s;
}
.quick-card:active { transform: scale(0.96); border-color: var(--rose-light); }
.quick-card .q-icon { font-size: 1.4rem; margin-bottom: 0.5rem; display: block; }
.quick-card .q-label { font-size: 0.78rem; font-weight: 500; }
.quick-card .q-sub { font-size: 0.68rem; color: var(--gray); margin-top: 0.2rem; }

/* Today's class */
.today-class {
  background: linear-gradient(135deg, var(--rose-light), var(--gold-light));
  border-radius: 16px;
  padding: 1.2rem;
  margin-bottom: 0.9rem;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.today-icon { font-size: 2rem; flex-shrink: 0; }
.today-info .t-label { font-size: 0.68rem; color: var(--rose); letter-spacing: 0.08em; text-transform: uppercase; }
.today-info .t-name { font-family: 'Cormorant Garamond', serif; font-size: 1.15rem; font-weight: 600; margin: 0.1rem 0; }
.today-info .t-time { font-size: 0.75rem; color: var(--gray); }
.today-btn {
  margin-left: auto;
  background: var(--charcoal);
  color: var(--cream);
  border: none;
  border-radius: 100px;
  padding: 0.5rem 1rem;
  font-size: 0.75rem;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
}

/* CLASSES PAGE */
.class-filter {
  display: flex;
  gap: 0.5rem;
  overflow-x: auto;
  padding-bottom: 0.5rem;
  margin-bottom: 1rem;
  scrollbar-width: none;
}
.class-filter::-webkit-scrollbar { display: none; }

.cf-btn {
  padding: 0.4rem 1rem;
  border-radius: 100px;
  border: 1.5px solid var(--light);
  background: var(--warm);
  font-size: 0.75rem;
  cursor: pointer;
  white-space: nowrap;
  font-family: 'DM Sans', sans-serif;
  transition: all 0.2s;
  color: var(--gray);
}
.cf-btn.active {
  background: var(--charcoal);
  border-color: var(--charcoal);
  color: var(--cream);
}

.class-card {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 18px;
  padding: 1.2rem;
  margin-bottom: 0.9rem;
}

.cc-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
.cc-badge {
  font-size: 0.65rem;
  padding: 0.25rem 0.7rem;
  border-radius: 100px;
  background: var(--cream);
  border: 1px solid var(--light);
  color: var(--gray);
}
.cc-badge.enrolled { background: var(--sage-light); border-color: var(--sage); color: var(--sage); }
.cc-badge.open { background: var(--gold-light); border-color: var(--gold); color: #8a6a30; }

.cc-emoji { font-size: 1.5rem; }
.cc-name { font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; font-weight: 600; margin-bottom: 0.2rem; }
.cc-desc { font-size: 0.78rem; color: var(--gray); font-family: 'Noto Serif KR', serif; font-weight: 300; line-height: 1.5; margin-bottom: 0.8rem; }

.cc-meta { display: flex; gap: 1rem; margin-bottom: 0.8rem; }
.cc-meta-item { font-size: 0.72rem; color: var(--gray); display: flex; align-items: center; gap: 0.3rem; }

.cc-btn {
  width: 100%;
  padding: 0.75rem;
  border-radius: 100px;
  border: none;
  font-size: 0.82rem;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
}
.cc-btn.primary { background: var(--charcoal); color: var(--cream); }
.cc-btn.primary:hover { background: var(--rose); }
.cc-btn.enrolled-btn { background: var(--sage-light); color: var(--sage); }

/* HOMEWORK */
.hw-tabs {
  display: flex;
  background: var(--light);
  border-radius: 12px;
  padding: 3px;
  margin-bottom: 1.2rem;
}
.hw-tab {
  flex: 1;
  padding: 0.6rem;
  border: none;
  background: none;
  border-radius: 10px;
  font-size: 0.78rem;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--gray);
}
.hw-tab.active {
  background: var(--warm);
  color: var(--charcoal);
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.hw-card {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 16px;
  padding: 1.1rem;
  margin-bottom: 0.8rem;
}

.hw-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
.hw-status {
  font-size: 0.65rem;
  padding: 0.2rem 0.6rem;
  border-radius: 100px;
}
.hw-status.pending { background: var(--gold-light); color: #8a6a30; }
.hw-status.done { background: var(--sage-light); color: var(--sage); }
.hw-status.late { background: var(--rose-light); color: var(--rose); }

.hw-class { font-size: 0.68rem; color: var(--rose); text-transform: uppercase; letter-spacing: 0.08em; }
.hw-title { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; font-weight: 600; margin: 0.2rem 0; }
.hw-desc { font-size: 0.76rem; color: var(--gray); font-family: 'Noto Serif KR', serif; font-weight: 300; line-height: 1.5; margin-bottom: 0.8rem; }
.hw-due { font-size: 0.72rem; color: var(--gray); margin-bottom: 0.8rem; }
.hw-due span { color: var(--warning); font-weight: 500; }

.hw-submit-btn {
  width: 100%;
  padding: 0.7rem;
  border-radius: 100px;
  border: 1.5px solid var(--light);
  background: var(--cream);
  font-size: 0.8rem;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--charcoal);
}
.hw-submit-btn:hover { border-color: var(--rose); color: var(--rose); }
.hw-submit-btn.done-btn { background: var(--sage-light); border-color: var(--sage); color: var(--sage); }

/* COMMUNITY */
.community-write {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 14px;
  padding: 0.9rem 1rem;
  margin-bottom: 1.2rem;
  cursor: pointer;
}
.cw-text { font-size: 0.82rem; color: var(--gray); }

.post-card {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 16px;
  padding: 1.1rem;
  margin-bottom: 0.8rem;
}

.post-top { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.7rem; }
.post-avatar {
  width: 30px; height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
  flex-shrink: 0;
}
.post-user { font-size: 0.8rem; font-weight: 500; }
.post-time { font-size: 0.68rem; color: var(--gray); margin-left: auto; }
.post-badge-tag {
  font-size: 0.62rem;
  padding: 0.15rem 0.5rem;
  border-radius: 100px;
  background: var(--rose-light);
  color: var(--rose);
}

.post-content { font-size: 0.82rem; line-height: 1.6; margin-bottom: 0.7rem; font-family: 'Noto Serif KR', serif; font-weight: 300; }

.post-actions { display: flex; gap: 1rem; }
.post-action { font-size: 0.72rem; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 0.3rem; }
.post-action:hover { color: var(--rose); }

/* COACH DASHBOARD */
.coach-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.7rem;
  margin-bottom: 1.2rem;
}

.coach-stat {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 14px;
  padding: 0.9rem 0.7rem;
  text-align: center;
}
.cs-num { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 600; color: var(--charcoal); }
.cs-label { font-size: 0.65rem; color: var(--gray); margin-top: 0.1rem; }

.student-card {
  background: var(--warm);
  border: 1.5px solid var(--light);
  border-radius: 16px;
  padding: 1rem;
  margin-bottom: 0.8rem;
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

.s-avatar {
  width: 42px; height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
  font-weight: 600;
  flex-shrink: 0;
}

.s-info { flex: 1; min-width: 0; }
.s-name { font-size: 0.88rem; font-weight: 600; margin-bottom: 0.15rem; }
.s-class { font-size: 0.7rem; color: var(--gray); }
.s-progress { margin-top: 0.4rem; }
.s-progress-text { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--gray); margin-bottom: 0.2rem; }

.s-action {
  background: none;
  border: 1.5px solid var(--light);
  border-radius: 100px;
  padding: 0.4rem 0.9rem;
  font-size: 0.72rem;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  color: var(--charcoal);
  transition: all 0.2s;
  flex-shrink: 0;
}
.s-action:hover { border-color: var(--rose); color: var(--rose); }

/* FEEDBACK CARD */
.feedback-card {
  background: linear-gradient(135deg, var(--cream), var(--rose-light));
  border-radius: 16px;
  padding: 1.2rem;
  margin-bottom: 0.9rem;
  border: 1px solid var(--rose-light);
}

.fb-from { font-size: 0.68rem; color: var(--rose); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.3rem; }
.fb-content { font-size: 0.82rem; line-height: 1.6; color: var(--charcoal); font-family: 'Noto Serif KR', serif; font-weight: 300; margin-bottom: 0.5rem; }
.fb-time { font-size: 0.65rem; color: var(--gray); }

/* PROFILE */
.profile-header {
  background: linear-gradient(135deg, var(--charcoal), var(--navy));
  border-radius: 20px;
  padding: 1.5rem;
  text-align: center;
  margin-bottom: 1.2rem;
  color: var(--cream);
}

.profile-avatar-big {
  width: 64px; height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--rose-light), var(--gold-light));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--charcoal);
  margin: 0 auto 0.8rem;
  border: 3px solid rgba(255,255,255,0.2);
}

.profile-name { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; font-weight: 600; margin-bottom: 0.2rem; }
.profile-package { font-size: 0.72rem; color: var(--gold-light); }

.profile-list { background: var(--warm); border-radius: 16px; overflow: hidden; border: 1.5px solid var(--light); margin-bottom: 0.9rem; }
.profile-item {
  display: flex;
  align-items: center;
  padding: 0.9rem 1.1rem;
  border-bottom: 1px solid var(--light);
  cursor: pointer;
  transition: background 0.2s;
  gap: 0.8rem;
}
.profile-item:last-child { border-bottom: none; }
.profile-item:hover { background: var(--cream); }
.pi-icon { font-size: 1.1rem; width: 24px; text-align: center; }
.pi-label { font-size: 0.85rem; flex: 1; }
.pi-arrow { color: var(--gray); font-size: 0.8rem; }

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(44,44,44,0.5);
  backdrop-filter: blur(4px);
  z-index: 300;
  align-items: flex-end;
  justify-content: center;
  max-width: 430px;
  margin: 0 auto;
}
.modal-overlay.open { display: flex; }

.modal-sheet {
  background: var(--warm);
  border-radius: 24px 24px 0 0;
  padding: 1.5rem 1.5rem 2.5rem;
  width: 100%;
  max-height: 88vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-handle {
  width: 40px; height: 4px;
  background: var(--light);
  border-radius: 100px;
  margin: 0 auto 1.2rem;
}

.modal-title { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; }

.m-input {
  width: 100%;
  background: var(--cream);
  border: 1.5px solid var(--light);
  border-radius: 12px;
  padding: 0.8rem 1rem;
  font-size: 0.88rem;
  font-family: 'DM Sans', sans-serif;
  outline: none;
  margin-bottom: 0.8rem;
  transition: border-color 0.2s;
}
.m-input:focus { border-color: var(--rose); }

textarea.m-input { min-height: 100px; resize: none; }

.m-btn {
  width: 100%;
  background: var(--charcoal);
  color: var(--cream);
  border: none;
  border-radius: 100px;
  padding: 0.9rem;
  font-size: 0.88rem;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  transition: background 0.2s;
}
.m-btn:hover { background: var(--rose); }

/* TOAST */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--charcoal);
  color: var(--cream);
  padding: 0.7rem 1.5rem;
  border-radius: 100px;
  font-size: 0.8rem;
  opacity: 0;
  transition: all 0.3s;
  z-index: 400;
  white-space: nowrap;
  max-width: 380px;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* BADGE */
.badge {
  display: inline-block;
  min-width: 18px;
  height: 18px;
  background: var(--rose);
  color: white;
  border-radius: 100px;
  font-size: 0.6rem;
  font-weight: 600;
  text-align: center;
  line-height: 18px;
  padding: 0 4px;
  margin-left: 4px;
  vertical-align: top;
}
</style>

  <!-- â•â•â• FIREBASE SDK â•â•â• -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”§ ì—¬ê¸°ì— Firebase ì„¤ì •ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
    // Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ì„¤ì • â†’ ì•± ì¶”ê°€ â†’ ì›¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const firebaseConfig = {
      apiKey: "AIzaSyBhBspbdqjZG2w1JTGbxjAwOZh5PCTF9AM",
      authDomain: "ivyel-elingo.firebaseapp.com",
      projectId: "ivyel-elingo",
      storageBucket: "ivyel-elingo.firebasestorage.app",
      messagingSenderId: "265463681271",
      appId: "1:265463681271:web:6c203c3ce00fd9452b03f2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // â”€â”€ ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (HTML onclickì—ì„œ ì‚¬ìš©) â”€â”€
    window._app = app;  // Storage ì´ˆê¸°í™”ì— í•„ìš”
    window._auth = auth;
    window._db = db;
    window._createUser = createUserWithEmailAndPassword;
    window._signIn = signInWithEmailAndPassword;
    window._signOut = signOut;
    window._doc = doc;
    window._setDoc = setDoc;
    window._getDoc = getDoc;
    window._collection = collection;
    window._addDoc = addDoc;
    window._getDocs = getDocs;
    window._query = query;
    window._where = where;
    window._orderBy = orderBy;
    window._serverTimestamp = serverTimestamp;

    // â”€â”€ ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€: ìƒˆë¡œê³ ì¹¨í•´ë„ ë¡œê·¸ì¸ ìœ ì§€ â”€â”€
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // ë¡œê·¸ì¸ ìƒíƒœ â†’ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          window._currentUser = { uid: user.uid, email: user.email, ...data };
          showAppAfterLogin(data);
        }
      } else {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
        window._currentUser = null;
        if (typeof _mySubUnsub === 'function') { _mySubUnsub(); _mySubUnsub = null; }
        if (typeof _communityUnsub === 'function') { _communityUnsub(); _communityUnsub = null; }
        if (typeof _coachCommunityUnsub === 'function') { _coachCommunityUnsub(); _coachCommunityUnsub = null; }
        if (typeof _assignedHwUnsub === 'function') { _assignedHwUnsub(); _assignedHwUnsub = null; }
        if (Array.isArray(_quickUnsubs)) { _quickUnsubs.forEach(function(fn){ fn(); }); _quickUnsubs = []; }
        // ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° ë°•ìŠ¤ ë¦¬ì…‹
        var ca = document.getElementById('communityAvatar');
        var ct = document.getElementById('communityWriteText');
        var wb = document.getElementById('communityWriteBox');
        if (ca) { ca.textContent = '?'; ca.style.background = ''; ca.style.color = ''; }
        if (ct) ct.textContent = 'ì˜¤ëŠ˜ì˜ ì˜ì–´ í•œë§ˆë””ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”... âœï¸';
        if (wb) wb.style.borderColor = '';
        // í•˜ë‹¨ë°” ìˆ™ì œ ë°°ì§€ ë¦¬ì…‹
        var navBadge = document.getElementById('navHwBadge');
        if (navBadge) { navBadge.textContent = '0'; navBadge.style.display = 'none'; }
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('app').classList.remove('show');
        // ìˆ™ì œ íƒ­/ì„¹ì…˜ ì´ˆê¸°í™”
        var _ps = document.getElementById('hw-pending-section');
        var _ds = document.getElementById('hw-done-section');
        if (_ps) _ps.style.display = 'block';
        if (_ds) _ds.style.display = 'none';
        document.querySelectorAll('.hw-tab').forEach(function(t, i) {
          t.classList.toggle('active', i === 0);
        });
        // ë¯¸ì œì¶œ ì¹´ë“œ ìƒíƒœ ë³µì›
        document.querySelectorAll('.hw-card[data-hw]').forEach(function(card) {
          var submitBtn = card.querySelector('.hw-submit-btn');
          if (submitBtn && submitBtn.classList.contains('done-btn')) {
            // ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ì§€ ì•ŠìŒ (í•˜ë“œì½”ë”© ì¹´ë“œë¼ ìƒˆë¡œê³ ì¹¨ ì‹œ ì›ìƒë³µêµ¬)
          }
        });
        // ì½”ì¹˜ íƒ­ ì œê±°
        var _cn = document.getElementById('coachNavBtn');
        if (_cn) _cn.remove();
      }
    });
  </script>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-logo">IVY<span>Â·</span>EL</div>
  <div class="login-sub">Elingo Learning App</div>

  <div class="role-select">
    <div class="role-label">ë¡œê·¸ì¸ ìœ í˜•</div>
    <div class="role-btns">
      <div class="role-btn active" onclick="selectRole('student', this)">
        <span class="role-icon">ğŸ“</span>
        <span class="role-name">í•™ìƒ</span>
      </div>
      <div class="role-btn" onclick="selectRole('coach', this)">
        <span class="role-icon">ğŸ‘©â€ğŸ«</span>
        <span class="role-name">ì½”ì¹˜</span>
      </div>
    </div>
  </div>

  <!-- íƒ­: ë¡œê·¸ì¸ / íšŒì›ê°€ì… -->
  <div style="display:flex; gap:0; border:1.5px solid var(--light); border-radius:12px; overflow:hidden; margin-bottom:1.2rem; width:100%;">
    <button id="tabLogin" onclick="switchAuthTab('login')"
      style="flex:1; padding:.7rem; background:var(--charcoal); color:var(--cream); border:none; font-family:'DM Sans',sans-serif; font-size:.85rem; font-weight:600; cursor:pointer;">
      ë¡œê·¸ì¸
    </button>
    <button id="tabSignup" onclick="switchAuthTab('signup')"
      style="flex:1; padding:.7rem; background:var(--warm); color:var(--gray); border:none; font-family:'DM Sans',sans-serif; font-size:.85rem; cursor:pointer;">
      íšŒì›ê°€ì…
    </button>
  </div>

  <!-- ë¡œê·¸ì¸ í¼ -->
  <div class="login-form" id="formLogin">
    <input class="l-input" id="loginEmail" type="email" placeholder="ì´ë©”ì¼">
    <input class="l-input" id="loginPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="login-btn" onclick="doLogin()">ë¡œê·¸ì¸</button>
    <p id="loginError" style="color:var(--rose);font-size:.78rem;text-align:center;margin-top:.5rem;display:none;"></p>
  </div>

  <!-- íšŒì›ê°€ì… í¼ -->
  <div class="login-form" id="formSignup" style="display:none;">
    <input class="l-input" id="signupName" type="text" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ì§€ì€)">
    <input class="l-input" id="signupEmail" type="email" placeholder="ì´ë©”ì¼">
    <input class="l-input" id="signupPassword" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
    <button class="login-btn" onclick="doSignup()">íšŒì›ê°€ì…</button>
    <p id="signupError" style="color:var(--rose);font-size:.78rem;text-align:center;margin-top:.5rem;display:none;"></p>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-logo">IVY<span>Â·</span>EL</div>
      <div class="topbar-user">
        <div class="avatar" id="topAvatar">ê¹€</div>
        <div>
          <div class="user-name" id="topName">ê¹€ì§€ì€</div>
          <div class="user-role" id="topRole">í•™ìƒ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGES -->
  <div class="page-content">

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="greeting">
        <div class="greeting-hello">Good morning âœ¦</div>
        <div class="greeting-name">ì•ˆë…•í•˜ì„¸ìš”, <em id="greetName">ì§€ì€</em>ë‹˜</div>
        <div class="greeting-stats">
          <div class="g-stat">
            <div class="g-stat-num" id="statAttend">12</div>
            <div class="g-stat-label">ì¶œì„</div>
          </div>
          <div class="g-stat">
            <div class="g-stat-num" id="statHw">3</div>
            <div class="g-stat-label">ìˆ™ì œ</div>
          </div>
          <div class="g-stat">
            <div class="g-stat-num" id="statStreak">7</div>
            <div class="g-stat-label">ì—°ì†ì¼</div>
          </div>
        </div>
      </div>

      <!-- Today's class -->
      <div class="sec-title">ì˜¤ëŠ˜ì˜ <em>ìˆ˜ì—…</em></div>
      <div class="sec-sub" style="margin-bottom:0.8rem;">Today's Schedule</div>
      <div id="home-today-classes">
        <div style="background:var(--warm);border-radius:14px;padding:1rem;text-align:center;font-size:.82rem;color:var(--gray);">
          ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ì–´ìš”.<br>
          <span style="font-size:.75rem;">ìˆ˜ì—… íƒ­ì—ì„œ ì‹ ì²­í•´ë³´ì„¸ìš” â†’</span>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="sec-title" style="margin-top:0.5rem;">ë¹ ë¥¸ <em>ë©”ë‰´</em></div>
      <div class="sec-sub" style="margin-bottom:0.8rem;">Quick Access</div>

      <div class="quick-grid">
        <div class="quick-card" onclick="switchPage('homework', null)">
          <span class="q-icon">ğŸ“</span>
          <div class="q-label">ìˆ™ì œ ì œì¶œ</div>
          <div class="q-sub" id="quick-hw">ë¯¸ì œì¶œ í™•ì¸ ì¤‘...</div>
        </div>
        <div class="quick-card" onclick="switchPage('community', null)">
          <span class="q-icon">ğŸ’¬</span>
          <div class="q-label">ì»¤ë®¤ë‹ˆí‹°</div>
          <div class="q-sub" id="quick-community">í™•ì¸ ì¤‘...</div>
        </div>
        <div class="quick-card" onclick="openChapterListModal()">
          <span class="q-icon">ğŸ“š</span>
          <div class="q-label">í•™ìŠµ ìë£Œ</div>
          <div class="q-sub">ì´ë²ˆ ì£¼ ìë£Œ</div>
        </div>
        <div class="quick-card" onclick="switchPage('home', null); setTimeout(function(){ var fc = document.querySelector('.feedback-card'); if(fc) fc.scrollIntoView({behavior:'smooth'}); }, 100)">
          <span class="q-icon">ğŸ’Œ</span>
          <div class="q-label">ì½”ì¹˜ í”¼ë“œë°±</div>
          <div class="q-sub" id="quick-feedback">í™•ì¸ ì¤‘...</div>
        </div>
      </div>

      <!-- Coach feedback -->
      <div class="sec-title">ì½”ì¹˜ <em>í”¼ë“œë°±</em></div>
      <div class="sec-sub" style="margin-bottom:0.8rem;">ìµœê·¼ ë°›ì€ í”¼ë“œë°±</div>

      <div id="home-feedback-list">
        <div class="feedback-card" style="text-align:center;color:var(--gray);font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <!-- CLASSES -->
    <div class="page" id="page-classes">
      <div class="sec-title">Elingo <em>ìˆ˜ì—…</em></div>
      <div class="sec-sub">ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…ê³¼ ìƒˆ ìˆ˜ì—…ì„ í™•ì¸í•˜ì„¸ìš”</div>

      <div class="class-filter">
        <button class="cf-btn active" onclick="cfFilter('all', this)">ì „ì²´</button>
        <button class="cf-btn" onclick="cfFilter('bible', this)">ğŸ“– ì„±ê²½ì˜ì–´</button>
        <button class="cf-btn" onclick="cfFilter('speaking', this)">ğŸ’¬ íšŒí™”</button>
        <button class="cf-btn" onclick="cfFilter('writing', this)">âœï¸ ê¸€ì“°ê¸°</button>
        <button class="cf-btn" onclick="cfFilter('coaching', this)">ğŸŒ± ì½”ì¹­</button>
        <button class="cf-btn" onclick="cfFilter('kids', this)">ğŸŒ¿ ì–´ë¦°ì´</button>
      </div>

      <div class="class-card" data-type="bible" id="cc-bible">
        <div class="cc-top">
          <div class="cc-emoji">ğŸ“–</div>
          <span class="cc-badge open" id="badge-bible">ëª¨ì§‘ ì¤‘</span>
        </div>
        <div class="cc-name">ì„±ê²½ì˜ì–´ ì†Œê·¸ë£¹</div>
        <div class="cc-desc">ë§ì”€ì„ ì˜ì–´ë¡œ ì½ê³  ë‚˜ëˆ„ë©° ì˜ì–´ì™€ ì‹ ì•™ì´ í•¨ê»˜ ìë¼ëŠ” ìˆ˜ì—…ì…ë‹ˆë‹¤.</div>
        <div class="cc-meta">
          <div class="cc-meta-item">ğŸ“… ë§¤ì£¼ í™”/ëª©</div>
          <div class="cc-meta-item">â° ì˜¤í›„ 2ì‹œ</div>
          <div class="cc-meta-item">ğŸ‘¥ ì†Œê·¸ë£¹</div>
        </div>
        <button class="cc-btn primary" id="btn-bible" onclick="openEnrollModal('bible', 'ì„±ê²½ì˜ì–´ ì†Œê·¸ë£¹')">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>

      <div class="class-card" data-type="speaking" id="cc-speaking">
        <div class="cc-top">
          <div class="cc-emoji">ğŸ’¬</div>
          <span class="cc-badge open" id="badge-speaking">ëª¨ì§‘ ì¤‘</span>
        </div>
        <div class="cc-name">ì˜ì–´ íšŒí™” 1:1</div>
        <div class="cc-desc">ë§ì¶¤ í”¼ë“œë°±ìœ¼ë¡œ ì‹¤ì œ ì˜ì–´ íšŒí™” ìì‹ ê°ì„ í‚¤ì›ë‹ˆë‹¤.</div>
        <div class="cc-meta">
          <div class="cc-meta-item">ğŸ“… ë§¤ì£¼ ì›”/ìˆ˜</div>
          <div class="cc-meta-item">â° ì˜¤í›„ 4ì‹œ</div>
          <div class="cc-meta-item">ğŸ‘¤ 1:1</div>
        </div>
        <button class="cc-btn primary" id="btn-speaking" onclick="openEnrollModal('speaking', 'ì˜ì–´ íšŒí™” 1:1')">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>

      <div class="class-card" data-type="writing" id="cc-writing">
        <div class="cc-top">
          <div class="cc-emoji">âœï¸</div>
          <span class="cc-badge open" id="badge-writing">ëª¨ì§‘ ì¤‘</span>
        </div>
        <div class="cc-name">ì˜ì–´ ê¸€ì“°ê¸° ê³¼ì •</div>
        <div class="cc-desc">ì¼ê¸°ë¶€í„° ì—ì„¸ì´ê¹Œì§€, ë‚˜ë§Œì˜ ì˜ì–´ ê¸€ì“°ê¸° ë£¨í‹´ì„ ë§Œë“¤ì–´ìš”.</div>
        <div class="cc-meta">
          <div class="cc-meta-item">ğŸ“… ë§¤ì£¼ ê¸ˆ</div>
          <div class="cc-meta-item">â° ì˜¤ì „ 10ì‹œ</div>
          <div class="cc-meta-item">ğŸ‘¥ ì†Œê·¸ë£¹</div>
        </div>
        <button class="cc-btn primary" id="btn-writing" onclick="openEnrollModal('writing', 'ì˜ì–´ ê¸€ì“°ê¸° ê³¼ì •')">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>

      <div class="class-card" data-type="coaching" id="cc-coaching">
        <div class="cc-top">
          <div class="cc-emoji">ğŸŒ±</div>
          <span class="cc-badge open" id="badge-coaching">ëª¨ì§‘ ì¤‘</span>
        </div>
        <div class="cc-name">ì˜ì–´ ì½”ì¹­ (ìì‹ ê°/ë™ê¸°)</div>
        <div class="cc-desc">ì˜ì–´ ì‹¤ë ¥ë³´ë‹¤ ë§ˆì¸ë“œì…‹ë¶€í„°. 1:1 ì½”ì¹­ìœ¼ë¡œ ìì‹ ê°ì„ í‚¤ì›Œìš”.</div>
        <div class="cc-meta">
          <div class="cc-meta-item">ğŸ“… ê²©ì£¼ í† </div>
          <div class="cc-meta-item">â° ì˜¤ì „ 11ì‹œ</div>
          <div class="cc-meta-item">ğŸ‘¤ 1:1</div>
        </div>
        <button class="cc-btn primary" id="btn-coaching" onclick="openEnrollModal('coaching', 'ì˜ì–´ ì½”ì¹­')">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>

      <div class="class-card" data-type="kids" id="cc-kids">
        <div class="cc-top">
          <div class="cc-emoji">ğŸŒ¿</div>
          <span class="cc-badge open" id="badge-kids">ëª¨ì§‘ ì¤‘</span>
        </div>
        <div class="cc-name">í‚¤ì¦ˆ ì˜ì–´</div>
        <div class="cc-desc">ë…¸ë˜, ìŠ¤í† ë¦¬, ê²Œì„ìœ¼ë¡œ ì˜ì–´ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ìŠ¤ë©°ë“œëŠ” ì–´ë¦°ì´ ìˆ˜ì—….</div>
        <div class="cc-meta">
          <div class="cc-meta-item">ğŸ“… ì£¼ 2íšŒ</div>
          <div class="cc-meta-item">â° ì˜¤í›„ 4ì‹œ</div>
          <div class="cc-meta-item">ğŸ‘¥ ì†Œê·¸ë£¹</div>
        </div>
        <button class="cc-btn primary" id="btn-kids" onclick="openEnrollModal('kids', 'í‚¤ì¦ˆ ì˜ì–´')">ìˆ˜ê°• ì‹ ì²­í•˜ê¸°</button>
      </div>
    </div>

    <!-- HOMEWORK -->
    <div class="page" id="page-homework">
      <div class="sec-title">ìˆ™ì œ &amp; <em>ê³¼ì œ</em></div>
      <div class="sec-sub">Homework &amp; Assignments</div>

      <div class="hw-tabs">
        <button class="hw-tab active" onclick="hwTab('pending', this)">ë¯¸ì œì¶œ <span class="badge" id="pendingBadge">2</span></button>
        <button class="hw-tab" data-tab="done" onclick="hwTab('done', this)">ì œì¶œ ì™„ë£Œ <span class="badge" id="doneBadge" style="display:none;background:var(--sage);">0</span></button>
        <button class="hw-tab" onclick="hwTab('all', this)">ì „ì²´</button>
      </div>

      <!-- ë¯¸ì œì¶œ ê³¼ì œ -->
      <div id="hw-pending-section">
        <!-- ì½”ì¹˜ê°€ Firebaseì—ì„œ ë‚¸ ìˆ™ì œ (ì‹¤ì‹œê°„) -->
        <div id="hw-assigned-list"></div>

        <!-- ëª©ì—… ìˆ™ì œ (ê¸°ì¡´ ìœ ì§€) -->
        <div id="hw-mock-list">
          <div class="hw-card" data-hw="pending">
            <div class="hw-top">
              <div class="hw-class">ğŸ“– ì„±ê²½ì˜ì–´</div>
              <span class="hw-status pending">ë¯¸ì œì¶œ</span>
            </div>
            <div class="hw-title">John 3ì¥ ì˜ì–´ë¡œ í•„ì‚¬í•˜ê¸°</div>
            <div class="hw-desc">ìš”í•œë³µìŒ 3ì¥ì„ ì˜ì–´ ì„±ê²½ìœ¼ë¡œ ì½ê³ , ë§ˆìŒì— ë‹¿ëŠ” êµ¬ì ˆ 3ê°œë¥¼ ì˜ì–´ë¡œ í•„ì‚¬í•´ì£¼ì„¸ìš”.</div>
            <div class="hw-due">ë§ˆê° <span>ë‚´ì¼ ì˜¤ì „ 9:00</span></div>
            <button class="hw-submit-btn" onclick="openSubmitModal('John 3ì¥ í•„ì‚¬')">ğŸ“ ì œì¶œí•˜ê¸°</button>
          </div>
          <div class="hw-card" data-hw="pending">
            <div class="hw-top">
              <div class="hw-class">ğŸ’¬ ì˜ì–´ íšŒí™”</div>
              <span class="hw-status pending">ë¯¸ì œì¶œ</span>
            </div>
            <div class="hw-title">ìê¸°ì†Œê°œ ì˜ì–´ë¡œ ë…¹ìŒí•˜ê¸°</div>
            <div class="hw-desc">1ë¶„ ë¶„ëŸ‰ì˜ ìê¸°ì†Œê°œë¥¼ ì˜ì–´ë¡œ ë…¹ìŒí•´ì„œ ì œì¶œí•´ì£¼ì„¸ìš”. í‹€ë ¤ë„ ê´œì°®ì•„ìš”!</div>
            <div class="hw-due">ë§ˆê° <span>ì´ë²ˆ ì£¼ ê¸ˆìš”ì¼</span></div>
            <button class="hw-submit-btn" onclick="openSubmitModal('ìê¸°ì†Œê°œ ë…¹ìŒ')">ğŸ¤ ì œì¶œí•˜ê¸°</button>
          </div>
        </div>
      </div>

      <!-- ì œì¶œ ì™„ë£Œ ëª©ë¡ (Firebaseì—ì„œ ë¡œë“œ) -->
      <div id="hw-done-section" style="display:none;">
        <div id="hw-done-list" style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <!-- COMMUNITY -->
    <div class="page" id="page-community">
      <div class="sec-title">ì»¤ë®¤ë‹ˆí‹° <em>ê²Œì‹œíŒ</em></div>
      <div class="sec-sub">í•¨ê»˜ ë‚˜ëˆ„ê³  ì‘ì›í•´ìš”</div>

      <!-- ê¸€ì“°ê¸° ë°•ìŠ¤ (í•™ìƒ/ì½”ì¹˜ ê³µí†µ, ë‚´ìš©ë§Œ ë¡œê·¸ì¸ í›„ ì—…ë°ì´íŠ¸) -->
      <div class="community-write" id="communityWriteBox" onclick="openModal('write', '')">
        <div class="avatar" id="communityAvatar" style="width:32px;height:32px;font-size:0.8rem;">?</div>
        <div class="cw-text" id="communityWriteText">ì˜¤ëŠ˜ì˜ ì˜ì–´ í•œë§ˆë””ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”... âœï¸</div>
      </div>

      <!-- Firebaseì—ì„œ ë¡œë“œëœ ìƒˆ ê¸€ -->
      <div id="community-new-posts"></div>

      <!-- ëª©ì—… ê¸€ (ê¸°ì¡´ ìœ ì§€) -->
      <div id="community-mock-posts">
        <div class="post-card">
          <div class="post-top">
            <div class="post-avatar" style="background:linear-gradient(135deg,var(--rose-light),var(--gold-light))">ì´</div>
            <div><div class="post-user">ì´ë¯¸ê²½</div></div>
            <span class="post-badge-tag">ì„±ê²½ì˜ì–´</span>
            <div class="post-time">10ë¶„ ì „</div>
          </div>
          <div class="post-content">"For God so loved the world" â€” ì˜¤ëŠ˜ ì´ êµ¬ì ˆì´ ë„ˆë¬´ ë§ˆìŒì— ì™€ë‹¿ì•˜ì–´ìš”. ì˜ì–´ë¡œ ì½ìœ¼ë‹ˆê¹Œ ë˜ ë‹¤ë¥¸ ê°ë™ì´ ìˆë„¤ìš” ğŸ™</div>
          <div class="post-actions">
            <div class="post-action" onclick="showToast('â¤ï¸ ì¢‹ì•„ìš”!')">â¤ï¸ 12</div>
            <div class="post-action" onclick="showToast('ëŒ“ê¸€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ’¬')">ğŸ’¬ ëŒ“ê¸€ 3</div>
            <div class="post-action" onclick="showToast('ì €ì¥ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ”–')">ğŸ”– ì €ì¥</div>
          </div>
        </div>

        <div class="post-card">
          <div class="post-top">
            <div class="post-avatar" style="background:linear-gradient(135deg,var(--sage-light),var(--gold-light))">ë°•</div>
            <div><div class="post-user">ë°•ìˆ˜ì—°</div></div>
            <span class="post-badge-tag">íšŒí™”</span>
            <div class="post-time">1ì‹œê°„ ì „</div>
          </div>
          <div class="post-content">ë“œë””ì–´ ìê¸°ì†Œê°œ ìˆ™ì œ ì œì¶œí–ˆì–´ìš”! ğŸ‰ ì²˜ìŒì—” ë„ˆë¬´ ë–¨ë ¸ëŠ”ë° ë§‰ìƒ í•˜ê³ ë‚˜ë‹ˆ ë¿Œë“¯í•˜ë„¤ìš”. ë‹¤ë“¤ í™”ì´íŒ…!!</div>
          <div class="post-actions">
            <div class="post-action" onclick="showToast('â¤ï¸ ì¢‹ì•„ìš”!')">â¤ï¸ 8</div>
            <div class="post-action" onclick="showToast('ëŒ“ê¸€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ’¬')">ğŸ’¬ ëŒ“ê¸€ 5</div>
            <div class="post-action" onclick="showToast('ì €ì¥ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ”–')">ğŸ”– ì €ì¥</div>
          </div>
        </div>

        <div class="post-card" style="border-color:var(--gold-light); background:linear-gradient(135deg,var(--warm),var(--gold-light))">
          <div class="post-top">
            <div class="post-avatar" style="background:var(--charcoal); color:var(--gold);">ì½”</div>
            <div><div class="post-user">ì½”ì¹˜ ğŸ“£</div></div>
            <div class="post-time">ì–´ì œ</div>
          </div>
          <div class="post-content">ì´ë²ˆ ì£¼ ìˆ˜ì—… ì •ë§ ëª¨ë‘ ìˆ˜ê³  ë§ì•˜ì–´ìš”! íŠ¹íˆ ìê¸°ì†Œê°œ ë…¹ìŒ ê³¼ì œ ë§ì´ë“¤ ì˜¬ë ¤ì£¼ì…¨ëŠ”ë° í•˜ë‚˜í•˜ë‚˜ ë‹¤ ë“¤ì—ˆì–´ìš” ğŸ’• ë‹¤ìŒ ì£¼ì—ë„ í•¨ê»˜ ì„±ì¥í•´ìš”!</div>
          <div class="post-actions">
            <div class="post-action" onclick="showToast('â¤ï¸ ì¢‹ì•„ìš”!')">â¤ï¸ 24</div>
            <div class="post-action" onclick="showToast('ëŒ“ê¸€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ’¬')">ğŸ’¬ ëŒ“ê¸€ 11</div>
          </div>
        </div>
      </div>
    </div>

    <!-- COACH PAGE (ê´€ë¦¬ì) -->
    <div class="page" id="page-coach">
      <div class="sec-title">ì½”ì¹˜ <em>ëŒ€ì‹œë³´ë“œ</em></div>
      <div class="sec-sub">í•™ìƒ ê´€ë¦¬ & ìˆ˜ì—… ìš´ì˜</div>

      <div class="coach-stats">
        <div class="coach-stat">
          <div class="cs-num">18</div>
          <div class="cs-label">ì „ì²´ í•™ìƒ</div>
        </div>
        <div class="coach-stat">
          <div class="cs-num">3</div>
          <div class="cs-label">ì˜¤ëŠ˜ ìˆ˜ì—…</div>
        </div>
        <div class="coach-stat">
          <div class="cs-num">7</div>
          <div class="cs-label">ë¯¸í™•ì¸ ìˆ™ì œ</div>
        </div>
      </div>

      <div class="sec-title" style="font-size:1.1rem;">í•™ìƒ <em>ëª©ë¡</em></div>
      <div class="sec-sub" style="margin-bottom:0.8rem;">ì§„ë„ & ì¶œì„ í˜„í™©</div>

      <!-- ì‹¤ì œ ê°€ì… í•™ìƒ (Firebase) - ìµœì‹  ê°€ì…ìˆœ ìƒë‹¨ -->
      <div id="coach-student-list">
        <div style="text-align:center;padding:1rem;color:var(--gray);font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- ëª©ì—… í•™ìƒ (í•˜ë‹¨ ê³ ì •) -->
      <div id="coach-mock-students">
        <div style="font-size:.68rem;color:var(--gray);text-align:center;padding:.4rem 0 .6rem;letter-spacing:.05em;">â€” ê¸°ì¡´ í•™ìƒ â€”</div>
        <div class="student-card">
          <div class="s-avatar" style="background:linear-gradient(135deg,var(--rose-light),var(--gold-light))">ê¹€</div>
          <div class="s-info">
            <div class="s-name">ê¹€ì§€ì€</div>
            <div class="s-class">ì„±ê²½ì˜ì–´ Â· íšŒí™” 1:1</div>
            <div class="s-progress">
              <div class="s-progress-text"><span>ì§„ë„</span><span>75%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:75%"></div></div>
            </div>
          </div>
          <button class="s-action" onclick="openMockStudentFeedback('ê¹€ì§€ì€')">í”¼ë“œë°±</button>
        </div>
        <div class="student-card">
          <div class="s-avatar" style="background:linear-gradient(135deg,var(--sage-light),var(--gold-light))">ë°•</div>
          <div class="s-info">
            <div class="s-name">ë°•ìˆ˜ì—°</div>
            <div class="s-class">íšŒí™” 1:1</div>
            <div class="s-progress">
              <div class="s-progress-text"><span>ì§„ë„</span><span>50%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:50%"></div></div>
            </div>
          </div>
          <button class="s-action" onclick="openMockStudentFeedback('ë°•ìˆ˜ì—°')">í”¼ë“œë°±</button>
        </div>
        <div class="student-card">
          <div class="s-avatar" style="background:linear-gradient(135deg,var(--gold-light),var(--rose-light))">ì´</div>
          <div class="s-info">
            <div class="s-name">ì´ë¯¸ê²½</div>
            <div class="s-class">ì„±ê²½ì˜ì–´ Â· ê¸€ì“°ê¸°</div>
            <div class="s-progress">
              <div class="s-progress-text"><span>ì§„ë„</span><span>90%</span></div>
              <div class="progress-bar"><div class="progress-fill" style="width:90%"></div></div>
            </div>
          </div>
          <button class="s-action" onclick="openMockStudentFeedback('ì´ë¯¸ê²½')">í”¼ë“œë°±</button>
        </div>
      </div>

      <div class="sec-title" style="font-size:1.1rem; margin-top:0.5rem;">ìˆ™ì œ <em>ë‚´ì£¼ê¸°</em></div>
      <div class="sec-sub" style="margin-bottom:0.8rem;">ì „ì²´Â·ìˆ˜ì—…ë³„Â·ê°œì¸ ìˆ™ì œ ë°œì†¡</div>
      <button onclick="openAssignHwModal()" style="width:100%;background:linear-gradient(135deg,var(--charcoal),#3a3a3a);color:var(--cream);border:none;border-radius:14px;padding:.85rem;font-size:.88rem;font-family:'DM Sans',sans-serif;cursor:pointer;margin-bottom:1.2rem;">âœï¸ ìƒˆ ìˆ™ì œ ë§Œë“¤ê¸°</button>

      <div class="sec-title" style="font-size:1.1rem;">ì œì¶œëœ <em>ê³¼ì œ</em></div>
      <div class="sec-sub" style="margin-bottom:0.8rem;">í•™ìƒ ê³¼ì œ í™•ì¸ & AI í”¼ë“œë°±</div>

      <!-- ì‹¤ì‹œê°„ ì œì¶œ ëª©ë¡ -->
      <div id="coach-hw-list">
        <div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- ìˆ˜ê°• ì‹ ì²­ ëª©ë¡ -->
      <div class="sec-title" style="font-size:1.1rem;margin-top:1.2rem;">ìˆ˜ê°• <em>ì‹ ì²­</em></div>
      <div class="sec-sub" style="margin-bottom:.8rem;">ì‹ ì²­ í™•ì¸ & ìˆ˜ë½</div>
      <div id="coach-enroll-list">
        <div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- íŒ¨í‚¤ì§€ ì‹ ì²­ ëª©ë¡ -->
      <div class="sec-title" style="font-size:1.1rem;margin-top:1.2rem;">íŒ¨í‚¤ì§€ <em>ì‹ ì²­ ì ‘ìˆ˜</em></div>
      <div class="sec-sub" style="margin-bottom:.8rem;">í™ˆí˜ì´ì§€ & ì•± ì‹ ì²­ í†µí•© ê´€ë¦¬</div>
      <div id="coach-package-list">
        <div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- API í‚¤ ì„¤ì • -->
      <div style="margin-top:1.2rem;padding:1rem;background:var(--warm);border:1.5px solid var(--light);border-radius:14px;">
        <div style="font-size:.75rem;color:var(--gray);margin-bottom:.6rem;">âš™ï¸ AI í”¼ë“œë°± ì„¤ì •</div>
        <button onclick="manageApiKey()" style="width:100%;background:none;border:1.5px solid var(--light);border-radius:100px;padding:.6rem;font-size:.78rem;font-family:'DM Sans',sans-serif;cursor:pointer;color:var(--charcoal);" id="apiKeyStatusBtn">
          ğŸ”‘ API í‚¤ í™•ì¸ ì¤‘...
        </button>
      </div>

      <!-- í•™ìŠµ ìë£Œ ê´€ë¦¬ -->
      <div class="sec-title" style="font-size:1.1rem;margin-top:1.4rem;">í•™ìŠµ <em>ìë£Œ ê´€ë¦¬</em></div>
      <div class="sec-sub" style="margin-bottom:.8rem;">ìˆ˜ì—…ë³„ Â· ê°œì¸ë³„ ìë£Œ ë§í¬ ì¶”ê°€</div>
      <button onclick="openAddMaterialModal()" style="width:100%;background:linear-gradient(135deg,#4a6fa5,#3a5a95);color:white;border:none;border-radius:14px;padding:.85rem;font-size:.88rem;font-family:'DM Sans',sans-serif;cursor:pointer;margin-bottom:.8rem;">ğŸ“ ìë£Œ ë§í¬ ì¶”ê°€í•˜ê¸°</button>
      <div id="coach-materials-list">
        <div style="text-align:center;padding:1rem;color:var(--gray);font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- í•™ìŠµ ì±•í„° ê´€ë¦¬ -->
      <div class="sec-title" style="font-size:1.1rem;margin-top:1.4rem;">í•™ìŠµ <em>ì±•í„° ê´€ë¦¬</em></div>
      <div class="sec-sub" style="margin-bottom:.8rem;">ë‹¨ì–´Â·êµ¬ì ˆÂ·í€´ì¦ˆë¥¼ ì…ë ¥í•˜ë©´ í•™ìƒ ì•±ì— ë°”ë¡œ ë°˜ì˜ë¼ìš”</div>
      <button onclick="openChapterModal()" style="width:100%;background:linear-gradient(135deg,var(--sage),#5a9a60);color:white;border:none;border-radius:14px;padding:.85rem;font-size:.88rem;font-family:'DM Sans',sans-serif;cursor:pointer;margin-bottom:.8rem;">ğŸ“– ìƒˆ ì±•í„° ë§Œë“¤ê¸°</button>
      <div id="coach-chapter-list">
        <div style="text-align:center;padding:1rem;color:var(--gray);font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

    </div>

    <!-- PROFILE -->
    <div class="page" id="page-profile">
      <div class="profile-header">
        <div class="profile-avatar-big" id="profileAvatar">ê¹€</div>
        <div class="profile-name" id="profileName">ê¹€ì§€ì€</div>
        <div class="profile-package" id="profilePackage">âœ¦ Elingo ì˜¬ì¸ì› 6ê°œì›”</div>
      </div>

      <div class="sec-title" style="font-size:1.1rem;">ë‚˜ì˜ <em>í•™ìŠµ í˜„í™©</em></div>
      <div class="card" style="margin-bottom:1.2rem;">
        <div style="display:flex; justify-content:space-between; margin-bottom:0.8rem;">
          <span style="font-size:0.78rem; color:var(--gray);">ì „ì²´ ì§„ë„</span>
          <span style="font-size:0.78rem; font-weight:600;">63%</span>
        </div>
        <div class="progress-bar" style="height:8px;"><div class="progress-fill" style="width:63%"></div></div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.5rem; margin-top:1rem; text-align:center;">
          <div>
            <div style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600;">20</div>
            <div style="font-size:0.65rem; color:var(--gray);">ì´ ìˆ˜ì—…</div>
          </div>
          <div>
            <div style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600; color:var(--success);">18</div>
            <div style="font-size:0.65rem; color:var(--gray);">ì¶œì„</div>
          </div>
          <div>
            <div style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:600; color:var(--rose);">2</div>
            <div style="font-size:0.65rem; color:var(--gray);">ê²°ì„</div>
          </div>
        </div>
      </div>

      <div class="profile-list">
        <div class="profile-item" onclick="openMyMaterials()">
          <span class="pi-icon">ğŸ“š</span>
          <span class="pi-label">ë‚´ í•™ìŠµ ìë£Œ</span>
          <span class="pi-arrow">â€º</span>
        </div>
        <div class="profile-item" onclick="window.location.href='ivyel-packages.html'">
          <span class="pi-icon">ğŸ’³</span>
          <span class="pi-label">ê²°ì œ & íŒ¨í‚¤ì§€ ê´€ë¦¬</span>
          <span class="pi-arrow">â€º</span>
        </div>
        <div class="profile-item" onclick="openNotificationSettings()">
          <span class="pi-icon">ğŸ””</span>
          <span class="pi-label">ì•Œë¦¼ ì„¤ì •</span>
          <span class="pi-arrow">â€º</span>
        </div>
        <div class="profile-item" onclick="switchPage('classes', null)">
          <span class="pi-icon">ğŸ“…</span>
          <span class="pi-label">ìˆ˜ì—… ì¼ì •</span>
          <span class="pi-arrow">â€º</span>
        </div>
        <div class="profile-item" onclick="doLogout()">
          <span class="pi-icon">ğŸšª</span>
          <span class="pi-label" style="color:var(--rose);">ë¡œê·¸ì•„ì›ƒ</span>
          <span class="pi-arrow">â€º</span>
        </div>
      </div>
    </div>

  </div><!-- /page-content -->

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchPage('home', this)">
      <span class="nav-icon">ğŸ </span>
      <span class="nav-label">í™ˆ</span>
    </button>
    <button class="nav-item" onclick="switchPage('classes', this)">
      <span class="nav-icon">ğŸ“–</span>
      <span class="nav-label">ìˆ˜ì—…</span>
    </button>
    <button class="nav-item" onclick="switchPage('homework', this)">
      <span class="nav-icon">ğŸ“</span>
      <span class="nav-label">ìˆ™ì œ<span class="badge" id="navHwBadge">0</span></span>
    </button>
    <button class="nav-item" onclick="switchPage('community', this)">
      <span class="nav-icon">ğŸ’¬</span>
      <span class="nav-label">ì»¤ë®¤ë‹ˆí‹°</span>
    </button>
    <button class="nav-item" id="lastNavItem" onclick="switchPage('profile', this)">
      <span class="nav-icon">ğŸ‘¤</span>
      <span class="nav-label">ë‚´ ì •ë³´</span>
    </button>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">â€”</div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
let currentRole = 'student';
let currentPage = 'home';

// â”€â”€ íƒ­ ì „í™˜ â”€â”€
function switchAuthTab(tab) {
  const isLogin = tab === 'login';
  document.getElementById('formLogin').style.display = isLogin ? 'block' : 'none';
  document.getElementById('formSignup').style.display = isLogin ? 'none' : 'block';
  document.getElementById('tabLogin').style.background = isLogin ? 'var(--charcoal)' : 'var(--warm)';
  document.getElementById('tabLogin').style.color = isLogin ? 'var(--cream)' : 'var(--gray)';
  document.getElementById('tabSignup').style.background = isLogin ? 'var(--warm)' : 'var(--charcoal)';
  document.getElementById('tabSignup').style.color = isLogin ? 'var(--gray)' : 'var(--cream)';
}

function selectRole(role, el) {
  currentRole = role;
  document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// â”€â”€ Firebase ë¡œê·¸ì¸ â”€â”€
async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  if (!email || !password) {
    errEl.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    errEl.style.display = 'block'; return;
  }

  try {
    const btn = document.querySelector('#formLogin .login-btn');
    btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...'; btn.disabled = true;
    await window._signIn(window._auth, email, password);
    // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ í™”ë©´ ì „í™˜ ì²˜ë¦¬
  } catch (err) {
    const msgs = {
      'auth/user-not-found': 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì´ì—ìš”.',
      'auth/wrong-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”.',
      'auth/invalid-email': 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.',
      'auth/too-many-requests': 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
      'auth/invalid-credential': 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.'
    };
    errEl.textContent = msgs[err.code] || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    errEl.style.display = 'block';
    const btn = document.querySelector('#formLogin .login-btn');
    btn.textContent = 'ë¡œê·¸ì¸'; btn.disabled = false;
  }
}

// â”€â”€ Firebase íšŒì›ê°€ì… â”€â”€
async function doSignup() {
  const name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const errEl = document.getElementById('signupError');
  errEl.style.display = 'none';

  if (!name || !email || !password) {
    errEl.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'; errEl.style.display = 'block'; return;
  }
  if (password.length < 6) {
    errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•´ìš”.'; errEl.style.display = 'block'; return;
  }

  try {
    const btn = document.querySelector('#formSignup .login-btn');
    btn.textContent = 'ê°€ì… ì¤‘...'; btn.disabled = true;

    // Firebase Auth ê³„ì • ìƒì„±
    const cred = await window._createUser(window._auth, email, password);

    // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
    await window._setDoc(window._doc(window._db, 'users', cred.user.uid), {
      name: name,
      email: email,
      role: currentRole,         // 'student' ë˜ëŠ” 'coach'
      createdAt: window._serverTimestamp(),
      package: currentRole === 'coach' ? 'ê´€ë¦¬ì' : 'Seed íŒ¨í‚¤ì§€'
    });

    showToast('âœ… ê°€ì… ì™„ë£Œ! í™˜ì˜í•´ìš” ' + name + 'ë‹˜ ğŸ‰');
    // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ í™”ë©´ ì „í™˜
  } catch (err) {
    const msgs = {
      'auth/email-already-in-use': 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì´ì—ìš”.',
      'auth/invalid-email': 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.',
      'auth/weak-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì§§ì•„ìš” (6ì ì´ìƒ).'
    };
    errEl.textContent = msgs[err.code] || 'ê°€ì…ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    errEl.style.display = 'block';
    const btn = document.querySelector('#formSignup .login-btn');
    btn.textContent = 'íšŒì›ê°€ì…'; btn.disabled = false;
  }
}

// â”€â”€ ë¡œê·¸ì¸ í›„ í™”ë©´ í‘œì‹œ â”€â”€
function showAppAfterLogin(userData) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').classList.add('show');

  const name = userData.name || 'í•™ìƒ';
  const role = userData.role || 'student';
  const initial = name.charAt(0);

  document.getElementById('topName').textContent = name;
  document.getElementById('topRole').textContent = role === 'coach' ? 'ì½”ì¹˜' : 'í•™ìƒ';
  document.getElementById('topAvatar').textContent = initial;
  document.getElementById('greetName').textContent = name;
  document.getElementById('profileName').textContent = name;
  document.getElementById('profileAvatar').textContent = initial;
  document.getElementById('profilePackage').textContent = 'âœ¦ ' + (userData.package || 'Seed íŒ¨í‚¤ì§€');

  if (role === 'coach') {
    // ì½”ì¹˜ íƒ­ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    if (!document.getElementById('coachNavBtn')) {
      const lastNav = document.getElementById('lastNavItem');
      const coachNav = document.createElement('button');
      coachNav.className = 'nav-item';
      coachNav.id = 'coachNavBtn';
      coachNav.innerHTML = '<span class="nav-icon">ğŸ‘©â€ğŸ«</span><span class="nav-label">ê´€ë¦¬</span>';
      coachNav.onclick = function() { switchPage('coach', this); loadCoachSubmissions(); loadCoachEnrollments(); loadCoachStudents(); loadCoachMaterials(); loadCoachChapters(); loadCoachPackageRequests(); updateApiKeyStatus(); };
      lastNav.parentNode.insertBefore(coachNav, lastNav);
    }
    // ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° ë°•ìŠ¤ - ì½”ì¹˜ ì „ìš© ìŠ¤íƒ€ì¼
    var ca = document.getElementById('communityAvatar');
    var ct = document.getElementById('communityWriteText');
    var wb = document.getElementById('communityWriteBox');
    if (ca) { ca.textContent = initial; ca.style.background = 'var(--charcoal)'; ca.style.color = 'var(--gold)'; }
    if (ct) ct.textContent = 'í•™ìƒë“¤ì—ê²Œ ê³µì§€ë‚˜ ì‘ì› ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”... ğŸ“£';
    if (wb) wb.style.borderColor = 'var(--gold-light)';

    setTimeout(loadCoachSubmissions, 500);
    setTimeout(loadCoachEnrollments, 600);
    setTimeout(loadCoachStudents, 700);
    setTimeout(loadCoachMaterials, 800);
    setTimeout(loadCoachChapters, 820);
    setTimeout(loadCoachPackageRequests, 850);
    setTimeout(updateApiKeyStatus, 900);
    setTimeout(loadCommunityPosts, 900); // ì»¤ë®¤ë‹ˆí‹°ë„ ë™ì¼ í•¨ìˆ˜ ì‚¬ìš©
  } else {
    // í•™ìƒ: ì´ë¯¸ ì œì¶œí•œ ê³¼ì œëŠ” ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ
    setTimeout(restoreSubmittedStatus, 500);
    setTimeout(loadHomeFeedback, 600);
    setTimeout(loadHomeTodayClasses, 650);
    setTimeout(loadCommunityPosts, 700);
    setTimeout(loadQuickStats, 800);
    setTimeout(restoreEnrollments, 900);
    setTimeout(loadAssignedHomework, 1000);
    // ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° ì•„ë°”íƒ€ ì´ë‹ˆì…œ ë™ê¸°í™”
    var ca = document.getElementById('communityAvatar');
    var wb = document.getElementById('communityWriteBox');
    if (ca) { ca.textContent = initial; ca.style.background = ''; ca.style.color = ''; }
    if (wb) wb.style.borderColor = '';
  }
}

// â”€â”€ ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸° ì œì¶œ â”€â”€
async function submitPost() {
  var content = (document.getElementById('postContent') || {}).value || '';
  var category = (document.getElementById('postCategory') || {}).value || 'ì¼ë°˜';
  content = content.trim();
  if (!content) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('postSubmitBtn');
  if (btn) { btn.textContent = 'ê²Œì‹œ ì¤‘...'; btn.disabled = true; }
  try {
    var user = window._currentUser;
    await window._addDoc(window._collection(window._db, 'posts'), {
      authorUid: user.uid,
      authorName: user.name,
      authorRole: user.role || 'student',
      category: category,
      content: content,
      likes: 0,
      createdAt: window._serverTimestamp()
    });
    closeModal();
    showToast('âœ… ê²Œì‹œê¸€ì´ ë“±ë¡ëì–´ìš”!');
    loadCommunityPosts();
  } catch(err) {
    showToast('ê²Œì‹œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    if (btn) { btn.textContent = 'ê²Œì‹œí•˜ê¸° â†’'; btn.disabled = false; }
    console.error(err);
  }
}

// â”€â”€ ì»¤ë®¤ë‹ˆí‹° ê¸€ ë¡œë“œ (ì‹¤ì‹œê°„) â”€â”€
var _communityUnsub = null;
async function loadCommunityPosts() {
  var newPostsEl = document.getElementById('community-new-posts');
  if (!newPostsEl) return;
  if (_communityUnsub) { _communityUnsub(); _communityUnsub = null; }
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var q = mod.query(mod.collection(window._db, 'posts'));
    _communityUnsub = mod.onSnapshot(q, function(snap) {
      if (snap.empty) { newPostsEl.innerHTML = ''; return; }
      var docs = [];
      snap.forEach(function(ds) { docs.push({ id: ds.id, data: ds.data() }); });
      docs.sort(function(a, b) {
        var ta = a.data.createdAt ? a.data.createdAt.seconds : 0;
        var tb = b.data.createdAt ? b.data.createdAt.seconds : 0;
        return tb - ta;
      });
      var categoryEmoji = { 'ì„±ê²½ì˜ì–´': 'ğŸ“–', 'íšŒí™”': 'ğŸ’¬', 'ì¼ë°˜': 'ğŸŒ±', 'ì§ˆë¬¸': 'â“' };
      var html = '';
      docs.forEach(function(item) {
        var d = item.data;
        var isCoach = d.authorRole === 'coach';
        var initial = (d.authorName || '?').charAt(0);
        var timeStr = d.createdAt ? timeAgo(new Date(d.createdAt.seconds * 1000)) : 'ë°©ê¸ˆ ì „';
        var emoji = categoryEmoji[d.category] || 'ğŸŒ±';
        var cardStyle = isCoach ? 'border-color:var(--gold-light);background:linear-gradient(135deg,var(--warm),var(--gold-light));' : '';
        var avatarStyle = isCoach ? 'background:var(--charcoal);color:var(--gold);' : 'background:linear-gradient(135deg,var(--rose-light),var(--gold-light));';
        html += '<div class="post-card" style="' + cardStyle + '">'
          + '<div class="post-top">'
          + '<div class="post-avatar" style="' + avatarStyle + '">' + initial + '</div>'
          + '<div><div class="post-user">' + (d.authorName || 'ìµëª…') + (isCoach ? ' ğŸ“£' : '') + '</div></div>'
          + (d.category ? '<span class="post-badge-tag">' + emoji + ' ' + d.category + '</span>' : '')
          + '<div class="post-time">' + timeStr + '</div>'
          + '</div>'
          + '<div class="post-content">' + d.content + '</div>'
          + '<div class="post-actions">'
          + '<div class="post-action" onclick="likePost(\'' + item.id + '\', this)">â¤ï¸ ' + (d.likes || 0) + '</div>'
          + '<div class="post-action" onclick="showToast(\'ëŒ“ê¸€ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ’¬\')">ğŸ’¬ ëŒ“ê¸€</div>'
          + '</div>'
          + '</div>';
      });
      newPostsEl.innerHTML = html;
    }, function(err) { console.error(err); });
  } catch(err) { console.error(err); }
}

// â”€â”€ ì¢‹ì•„ìš” â”€â”€
async function likePost(docId, el) {
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var ref = mod.doc(window._db, 'posts', docId);
    var snap = await mod.getDoc(ref);
    if (!snap.exists()) return;
    var newLikes = (snap.data().likes || 0) + 1;
    await mod.updateDoc(ref, { likes: newLikes });
    el.textContent = 'â¤ï¸ ' + newLikes;
    showToast('â¤ï¸ ì¢‹ì•„ìš”!');
  } catch(err) { console.error(err); }
}
// â”€â”€ í™ˆ ë¹ ë¥¸ ë©”ë‰´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ â”€â”€
var _quickUnsubs = [];
// â”€â”€ í™ˆ: ì˜¤ëŠ˜ì˜ ìˆ˜ì—… (ìˆ˜ê°• í™•ì • ê¸°ë°˜ ë™ì  í‘œì‹œ) â”€â”€
var classSchedule = {
  'bible':    { icon:'ğŸ“–', label:'ì„±ê²½ì˜ì–´ ì†Œê·¸ë£¹',  topic:'ë§ì”€ ì˜ì–´ë¡œ ì½ê¸°', time:'ì˜¤í›„ 2:00 Â· Zoom Â· 60ë¶„', bg:'' },
  'speaking': { icon:'ğŸ’¬', label:'ì˜ì–´ íšŒí™” 1:1',    topic:'Daily Conversation', time:'ì˜¤í›„ 4:00 Â· Zoom Â· 50ë¶„', bg:'background:linear-gradient(135deg,var(--sage-light),var(--gold-light));' },
  'writing':  { icon:'âœï¸', label:'ì˜ì–´ ê¸€ì“°ê¸° ê³¼ì •', topic:'ì´ë²ˆ ì£¼ ì—ì„¸ì´ ì‘ì„±', time:'ì˜¤ì „ 10:00 Â· Zoom Â· 60ë¶„', bg:'' },
  'coaching': { icon:'ğŸŒ±', label:'ì˜ì–´ ì½”ì¹­',        topic:'ëª©í‘œ ì„¤ì • & ë™ê¸° ì½”ì¹­', time:'ê²©ì£¼ í†  11:00 Â· Zoom Â· 50ë¶„', bg:'' },
  'kids':     { icon:'ğŸŒ¿', label:'í‚¤ì¦ˆ ì˜ì–´',        topic:'Phonics & Song Time', time:'ì˜¤í›„ 4:00 Â· Zoom Â· 40ë¶„', bg:'' }
};

async function loadHomeTodayClasses() {
  var el = document.getElementById('home-today-classes');
  if (!el) return;
  try {
    var user = window._currentUser;
    if (!user) return;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'enrollments'),
      mod.where('studentUid', '==', user.uid),
      mod.where('status', '==', 'active')
    ));
    if (snap.empty) {
      el.innerHTML = '<div style="background:var(--warm);border-radius:14px;padding:1rem 1.2rem;text-align:center;font-size:.82rem;color:var(--gray);">ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ì–´ìš”.<br><span style="font-size:.75rem;">ìˆ˜ì—… íƒ­ì—ì„œ ì‹ ì²­í•´ë³´ì„¸ìš” â†’</span></div>';
      return;
    }
    var html = '';
    snap.forEach(function(ds) {
      var d = ds.data();
      var info = classSchedule[d.classKey] || { icon:'ğŸ“š', label:d.className, topic:'ìˆ˜ì—… ì¤‘', time:'', bg:'' };
      html += '<div class="today-class" style="' + info.bg + 'margin-bottom:.6rem;">'
        + '<div class="today-icon">' + info.icon + '</div>'
        + '<div class="today-info">'
        + '<div class="t-label">' + info.label + '</div>'
        + '<div class="t-name">' + info.topic + '</div>'
        + '<div class="t-time">' + info.time + '</div>'
        + '</div>'
        + '<button class="today-btn" onclick="openZoom()">ì…ì¥</button>'
        + '</div>';
    });
    el.innerHTML = html;
  } catch(err) {
    el.innerHTML = '<div style="text-align:center;font-size:.82rem;color:var(--gray);padding:.8rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

async function loadQuickStats() {
  _quickUnsubs.forEach(function(fn) { fn(); });
  _quickUnsubs = [];
  var user = window._currentUser;
  if (!user) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

    // â‘  ìˆ™ì œ ë¯¸ì œì¶œ ìˆ˜ - DOM ê°ì‹œ
    function updateHwQuick() {
      var pending = document.querySelectorAll('#hw-pending-section .hw-card[data-hw="pending"]').length;
      var el = document.getElementById('quick-hw');
      if (el) el.textContent = pending > 0 ? 'ë¯¸ì œì¶œ ' + pending + 'ê°œ' : 'ëª¨ë‘ ì œì¶œ ì™„ë£Œ âœ“';
    }
    updateHwQuick();
    var hwSection = document.getElementById('hw-pending-section');
    if (hwSection) {
      var hwObs = new MutationObserver(updateHwQuick);
      hwObs.observe(hwSection, { subtree: true, attributes: true, attributeFilter: ['data-hw'] });
      _quickUnsubs.push(function() { hwObs.disconnect(); });
    }

    // â‘¡ ì»¤ë®¤ë‹ˆí‹° ìƒˆ ê¸€ ìˆ˜
    var postUnsub = mod.onSnapshot(mod.collection(window._db, 'posts'), function(snap) {
      var el = document.getElementById('quick-community');
      if (el) el.textContent = snap.size > 0 ? 'ìƒˆ ê¸€ ' + snap.size + 'ê°œ' : 'ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”';
    });
    _quickUnsubs.push(postUnsub);

    // â‘¢ ë°›ì€ í”¼ë“œë°± ìˆ˜
    var fbUnsub = mod.onSnapshot(
      mod.query(mod.collection(window._db, 'homework'),
        mod.where('studentUid', '==', user.uid),
        mod.where('status', '==', 'reviewed')),
      function(snap) {
        var el = document.getElementById('quick-feedback');
        if (el) el.textContent = snap.size > 0 ? 'ë°›ì€ í”¼ë“œë°± ' + snap.size + 'ê°œ' : 'ì•„ì§ í”¼ë“œë°± ì—†ìŒ';
      }
    );
    _quickUnsubs.push(fbUnsub);

  } catch(err) { console.error(err); }
}

async function loadHomeFeedback() {
  var listEl = document.getElementById('home-feedback-list');
  if (!listEl) return;
  try {
    var user = window._currentUser;
    if (!user) return;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

    // â‘  ê³¼ì œ í”¼ë“œë°± (homework ì»¬ë ‰ì…˜)
    var hwSnap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'homework'),
      mod.where('studentUid', '==', user.uid),
      mod.where('status', '==', 'reviewed')
    ));

    // â‘¡ ì§ì ‘ í”¼ë“œë°± (directFeedbacks ì»¬ë ‰ì…˜) - UID ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ì¡°íšŒ
    var dfSnap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'directFeedbacks'),
      mod.where('studentUid', '==', user.uid)
    ));
    // ì´ë¦„ ê¸°ë°˜ í”¼ë“œë°±ë„ ë³‘í•© (ëª©ì—… í•™ìƒ ëŒ€ì‘)
    var dfNameSnap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'directFeedbacks'),
      mod.where('studentName', '==', user.name),
      mod.where('studentUid', '==', null)
    ));

    var allDocs = [];

    hwSnap.forEach(function(ds) {
      var d = ds.data();
      allDocs.push({
        label: 'ğŸŒ¸ ' + (d.hwTitle || 'ê³¼ì œ') + ' í”¼ë“œë°±',
        content: d.feedback || '',
        ts: d.feedbackAt || d.submittedAt
      });
    });
    dfSnap.forEach(function(ds) {
      var d = ds.data();
      allDocs.push({
        label: 'ğŸ’Œ ì½”ì¹˜ ë©”ì‹œì§€',
        content: d.feedback || '',
        ts: d.createdAt
      });
    });
    dfNameSnap.forEach(function(ds) {
      var d = ds.data();
      allDocs.push({
        label: 'ğŸ’Œ ì½”ì¹˜ ë©”ì‹œì§€',
        content: d.feedback || '',
        ts: d.createdAt
      });
    });

    if (allDocs.length === 0) {
      listEl.innerHTML = '<div class="feedback-card" style="text-align:center;color:var(--gray);font-size:.82rem;padding:1.2rem;">ì•„ì§ ë°›ì€ í”¼ë“œë°±ì´ ì—†ì–´ìš” ğŸŒ±</div>';
      return;
    }

    // ìµœì‹ ìˆœ ì •ë ¬ í›„ ìµœëŒ€ 3ê±´
    allDocs.sort(function(a, b) {
      return (b.ts ? b.ts.seconds : 0) - (a.ts ? a.ts.seconds : 0);
    });
    allDocs = allDocs.slice(0, 3);

    var html = '';
    allDocs.forEach(function(d) {
      var timeStr = d.ts ? timeAgo(new Date(d.ts.seconds * 1000)) : '';
      html += '<div class="feedback-card">'
        + '<div class="fb-from">' + d.label + '</div>'
        + '<div class="fb-content">' + d.content + '</div>'
        + '<div class="fb-time">' + timeStr + '</div>'
        + '</div>';
    });
    listEl.innerHTML = html;
  } catch(err) {
    listEl.innerHTML = '<div class="feedback-card" style="text-align:center;color:var(--gray);font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

function timeAgo(date) {
  var diff = Math.floor((Date.now() - date.getTime()) / 1000);
  if (diff < 60) return 'ë°©ê¸ˆ ì „';
  if (diff < 3600) return Math.floor(diff / 60) + 'ë¶„ ì „';
  if (diff < 86400) return Math.floor(diff / 3600) + 'ì‹œê°„ ì „';
  if (diff < 604800) return Math.floor(diff / 86400) + 'ì¼ ì „';
  return date.toLocaleDateString('ko-KR');
}
async function restoreSubmittedStatus() {
  try {
    var user = window._currentUser;
    if (!user) return;
    var q = window._query(
      window._collection(window._db, 'homework'),
      window._where('studentUid', '==', user.uid)
    );
    var snap = await window._getDocs(q);
    var submittedTitles = [];
    snap.forEach(function(ds) { submittedTitles.push(ds.data().hwTitle); });

    // ì œì¶œëœ ê³¼ì œ ì¹´ë“œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.hw-card[data-hw="pending"]').forEach(function(card) {
      var titleEl = card.querySelector('.hw-title');
      if (!titleEl) return;
      var matched = submittedTitles.find(function(t) {
        return titleEl.textContent.includes(t.replace(' í•„ì‚¬','').replace(' ë…¹ìŒ',''));
      });
      if (matched) {
        card.dataset.hw = 'done';
        var statusEl = card.querySelector('.hw-status');
        if (statusEl) { statusEl.className = 'hw-status done'; statusEl.textContent = 'âœ“ ì œì¶œ ì™„ë£Œ'; }
        var btn = card.querySelector('.hw-submit-btn');
        if (btn) { btn.className = 'hw-submit-btn done-btn'; btn.textContent = 'âœ“ ì œì¶œ ì™„ë£Œ'; btn.onclick = null; }
      }
    });

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    var remaining = document.querySelectorAll('.hw-card[data-hw="pending"]').length;
    var pendingBadge = document.getElementById('pendingBadge');
    var doneBadge = document.getElementById('doneBadge');
    if (pendingBadge) pendingBadge.textContent = remaining;
    if (doneBadge && submittedTitles.length > 0) {
      doneBadge.textContent = submittedTitles.length;
      doneBadge.style.display = 'inline';
    }
  } catch(err) { console.error(err); }
}

// â”€â”€ Firebase ë¡œê·¸ì•„ì›ƒ â”€â”€
async function doLogout() {
  if (typeof _mySubUnsub === 'function') { _mySubUnsub(); _mySubUnsub = null; }
  await window._signOut(window._auth);
  // onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
}

function switchPage(name, navEl) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navEl) navEl.classList.add('active');
  currentPage = name;
  // í™ˆìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ í”¼ë“œë°± ìƒˆë¡œê³ ì¹¨
  if (name === 'home' && window._currentUser && window._currentUser.role !== 'coach') {
    loadHomeFeedback();
    loadHomeTodayClasses();
  }
}

function cfFilter(type, el) {
  document.querySelectorAll('.cf-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.class-card').forEach(c => {
    c.style.display = (type === 'all' || c.dataset.type === type) ? 'block' : 'none';
  });
}

function hwTab(type, el) {
  document.querySelectorAll('.hw-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');

  var pendingSection = document.getElementById('hw-pending-section');
  var doneSection = document.getElementById('hw-done-section');

  if (type === 'pending') {
    if (pendingSection) pendingSection.style.display = 'block';
    if (doneSection) doneSection.style.display = 'none';
  } else if (type === 'done') {
    if (pendingSection) pendingSection.style.display = 'none';
    if (doneSection) doneSection.style.display = 'block';
    loadMySubmissions();
  } else {
    // ì „ì²´
    if (pendingSection) pendingSection.style.display = 'block';
    if (doneSection) doneSection.style.display = 'block';
    loadMySubmissions();
  }
}

// â”€â”€ ë‚´ ì œì¶œ ì™„ë£Œ ëª©ë¡ (Firebase, ì‹¤ì‹œê°„) â”€â”€
var _mySubUnsub = null;
async function loadMySubmissions() {
  var listEl = document.getElementById('hw-done-list');
  if (!listEl) return;
  listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  if (_mySubUnsub) { _mySubUnsub(); _mySubUnsub = null; }
  try {
    var user = window._currentUser;
    if (!user) return;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var q = mod.query(
      mod.collection(window._db, 'homework'),
      mod.where('studentUid', '==', user.uid)
    );
    _mySubUnsub = mod.onSnapshot(q, function(snap) {
      // ë‚ ì§œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (JSì—ì„œ ì²˜ë¦¬, Firestore ë³µí•© ì¸ë±ìŠ¤ ë¶ˆí•„ìš”)
      var docs = [];
      snap.forEach(function(ds) { docs.push({ id: ds.id, data: ds.data() }); });
      docs.sort(function(a, b) {
        var ta = a.data.submittedAt ? a.data.submittedAt.seconds : 0;
        var tb = b.data.submittedAt ? b.data.submittedAt.seconds : 0;
        return tb - ta;
      });
      if (docs.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ì•„ì§ ì œì¶œí•œ ê³¼ì œê°€ ì—†ì–´ìš”</div>';
        var doneBadge = document.getElementById('doneBadge');
        if (doneBadge) doneBadge.style.display = 'none';
        return;
      }
      var html = ''; var count = 0;
      docs.forEach(function(item) {
        count++;
        var d = item.data;
        var date = d.submittedAt ? new Date(d.submittedAt.seconds * 1000).toLocaleDateString('ko-KR') : 'ë°©ê¸ˆ';
        var fileBtn = d.fileUrl ? '<a href="' + d.fileUrl + '" target="_blank" style="font-size:.75rem;color:var(--rose);text-decoration:none;display:block;margin:.3rem 0;">ğŸ“ ' + d.fileName + '</a>' : '';
        var fbBox = d.feedback
          ? '<div style="background:var(--sage-light);border-radius:10px;padding:.7rem 1rem;margin-top:.6rem;font-size:.82rem;color:#3a6b3e;">ğŸ’Œ <b>ì½”ì¹˜ í”¼ë“œë°±:</b><br>' + d.feedback + '</div>'
          : '<div style="background:var(--gold-light);border-radius:10px;padding:.6rem 1rem;margin-top:.6rem;font-size:.78rem;color:#8a6a30;">â³ ì½”ì¹˜ë‹˜ì´ í™•ì¸ ì¤‘ì´ì—ìš”</div>';
        html += '<div class="hw-card">'
          + '<div class="hw-top"><div class="hw-class">âœ“ ' + d.hwTitle + '</div>'
          + '<span class="hw-status done">' + (d.status === 'reviewed' ? 'âœ“ í”¼ë“œë°± ì™„ë£Œ' : 'âœ“ ì œì¶œ ì™„ë£Œ') + '</span></div>'
          + (d.text ? '<div style="font-size:.84rem;line-height:1.7;margin:.5rem 0;">' + d.text + '</div>' : '')
          + fileBtn
          + '<div style="font-size:.72rem;color:var(--gray);">ì œì¶œì¼: ' + date + '</div>'
          + fbBox + '</div>';
      });
      listEl.innerHTML = html;
      var doneBadge = document.getElementById('doneBadge');
      if (doneBadge) { doneBadge.textContent = count; doneBadge.style.display = 'inline'; }
    }, function(err) {
      listEl.innerHTML = '<div style="color:var(--rose);font-size:.82rem;text-align:center;padding:1rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
      console.error(err);
    });
  } catch(err) {
    listEl.innerHTML = '<div style="color:var(--rose);font-size:.82rem;text-align:center;padding:1rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

// â”€â”€ ìˆ˜ì—… ìë£Œ ë³´ê¸° ëª¨ë‹¬ â”€â”€
var materialMap = {
  'bible':    { emoji:'ğŸ“–', name:'ì„±ê²½ì˜ì–´ ì†Œê·¸ë£¹',  items:['John 3ì¥ ì˜ì–´ ë³¸ë¬¸ PDF','ë§ì”€ í•„ì‚¬ ë…¸íŠ¸ ì–‘ì‹','ì„±ê²½ì˜ì–´ í•µì‹¬ ë‹¨ì–´ì¥ 50ì„ ','ì´ë²ˆ ì£¼ ì˜ˆìŠµ ìë£Œ'] },
  'speaking': { emoji:'ğŸ’¬', name:'ì˜ì–´ íšŒí™” 1:1',    items:['íšŒí™” í‘œí˜„ 100ì„  PDF','ë°œìŒ êµì • ê°€ì´ë“œ','ì´ë²ˆ ì£¼ ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸','ì…€í”„ ì²´í¬ë¦¬ìŠ¤íŠ¸'] },
  'writing':  { emoji:'âœï¸', name:'ì˜ì–´ ê¸€ì“°ê¸° ê³¼ì •', items:['ê¸€ì“°ê¸° ì›Œí¬ì‹œíŠ¸ 1-4ì£¼ì°¨','ì—ì„¸ì´ êµ¬ì¡° ê°€ì´ë“œ','ì¼ê¸° ì“°ê¸° í…œí”Œë¦¿','êµì • ì˜ˆì‹œ ëª¨ìŒ'] },
  'coaching': { emoji:'ğŸŒ±', name:'ì˜ì–´ ì½”ì¹­',        items:['ìì‹ ê° ë¹Œë”© ì›Œí¬ë¶','í•™ìŠµ ëª©í‘œ ì„¤ì • ì‹œíŠ¸','1:1 ì½”ì¹­ ê¸°ë¡ì§€'] },
  'kids':     { emoji:'ğŸŒ¿', name:'í‚¤ì¦ˆ ì˜ì–´',        items:['íŒŒë‹‰ìŠ¤ ì›Œí¬ì‹œíŠ¸','ì˜ì–´ ë™ìš” ê°€ì‚¬ì§‘','ìŠ¤í‹°ì»¤ ë³´ìƒí‘œ','í•™ë¶€ëª¨ ê°€ì´ë“œ'] }
};

function openClassMaterials(classKey, className) {
  var info = materialMap[classKey] || { emoji:'ğŸ“„', name: className, items:[] };
  document.getElementById('modalTitle').textContent = info.emoji + ' ' + info.name + ' ìë£Œ';
  var itemsHtml = info.items.map(function(item) {
    return '<div style="display:flex;align-items:center;gap:.7rem;padding:.65rem .2rem;border-bottom:1px solid var(--light);">'
      + '<span style="font-size:1rem;">ğŸ“„</span>'
      + '<span style="font-size:.84rem;flex:1;">' + item + '</span>'
      + '<span style="font-size:.72rem;color:var(--rose);cursor:pointer;" onclick="showToast(\'ì¤€ë¹„ ì¤‘ì´ì—ìš” ğŸ’Œ\')">ë³´ê¸°</span>'
      + '</div>';
  }).join('');
  document.getElementById('modalBody').innerHTML = `
    <div style="background:var(--cream);border-radius:10px;padding:.6rem 1rem;margin-bottom:1rem;font-size:.78rem;color:var(--gray);">
      ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…ì˜ ìë£Œì˜ˆìš”. ì½”ì¹˜ë‹˜ì´ ì—…ë¡œë“œí•œ ìˆœì„œë¡œ í‘œì‹œë¼ìš”.
    </div>
    ${itemsHtml}`;
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ì½”ì¹˜: ìˆ™ì œ ë‚´ì£¼ê¸° ëª¨ë‹¬ â”€â”€
async function openAssignHwModal() {
  // ì‹¤ì œ í•™ìƒ ëª©ë¡ ë¡œë“œ
  var studentOptions = '<option value="all">ğŸ“¢ ì „ì²´ í•™ìƒ</option>';
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.query(mod.collection(window._db,'users'), mod.where('role','==','student')));
    snap.forEach(function(ds) {
      var d = ds.data();
      studentOptions += '<option value="' + ds.id + '">' + (d.name||'ì´ë¦„ì—†ìŒ') + ' (' + (d.email||'') + ')</option>';
    });
  } catch(e) {}

  document.getElementById('modalTitle').textContent = 'âœï¸ ìƒˆ ìˆ™ì œ ë§Œë“¤ê¸°';
  document.getElementById('modalBody').innerHTML = `
    <select class="m-input" id="hwTarget">${studentOptions}</select>
    <select class="m-input" id="hwClass">
      <option value="ì„±ê²½ì˜ì–´">ğŸ“– ì„±ê²½ì˜ì–´ë°˜</option>
      <option value="íšŒí™”">ğŸ’¬ ì˜ì–´ íšŒí™”ë°˜</option>
      <option value="ê¸€ì“°ê¸°">âœï¸ ê¸€ì“°ê¸°ë°˜</option>
      <option value="ì½”ì¹­">ğŸŒ± ì½”ì¹­ë°˜</option>
      <option value="í‚¤ì¦ˆ">ğŸŒ¿ í‚¤ì¦ˆë°˜</option>
      <option value="ì „ì²´">ğŸ“¢ ì „ì²´ ê³µí†µ</option>
    </select>
    <input class="m-input" id="hwTitleInput" placeholder="ìˆ™ì œ ì œëª© (ì˜ˆ: John 4ì¥ í•„ì‚¬í•˜ê¸°)">
    <textarea class="m-input" id="hwDescInput" rows="3" placeholder="ìˆ™ì œ ì„¤ëª… (ì„ íƒ)"></textarea>
    <input class="m-input" id="hwDueInput" type="date" placeholder="ë§ˆê°ì¼">
    <button class="m-btn" id="assignHwBtn" onclick="submitAssignHw()">ìˆ™ì œ ë°œì†¡í•˜ê¸° â†’</button>`;
  // ë‚ ì§œ ê¸°ë³¸ê°’ (7ì¼ í›„)
  var d = new Date(); d.setDate(d.getDate()+7);
  document.getElementById('hwDueInput').value = d.toISOString().split('T')[0];
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ì½”ì¹˜: ìˆ™ì œ Firebase ì €ì¥ â”€â”€
async function submitAssignHw() {
  var title = (document.getElementById('hwTitleInput')||{}).value.trim();
  if (!title) { showToast('ìˆ™ì œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var target  = document.getElementById('hwTarget').value;
  var cls     = document.getElementById('hwClass').value;
  var desc    = (document.getElementById('hwDescInput')||{}).value.trim();
  var dueVal  = (document.getElementById('hwDueInput')||{}).value;
  var btn     = document.getElementById('assignHwBtn');
  btn.textContent = 'ë°œì†¡ ì¤‘...'; btn.disabled = true;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.addDoc(mod.collection(window._db, 'assignments'), {
      title: title,
      desc: desc,
      className: cls,
      target: target,           // 'all' ë˜ëŠ” íŠ¹ì • studentUid
      dueDate: dueVal,
      createdAt: mod.serverTimestamp(),
      createdBy: window._currentUser.uid
    });
    closeModal();
    showToast('âœ… ìˆ™ì œë¥¼ ë°œì†¡í–ˆì–´ìš”!');
  } catch(err) {
    showToast('ë°œì†¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    btn.textContent = 'ìˆ™ì œ ë°œì†¡í•˜ê¸° â†’'; btn.disabled = false;
    console.error(err);
  }
}

// â”€â”€ í•™ìƒ: ì½”ì¹˜ê°€ ë‚¸ ìˆ™ì œ ì‹¤ì‹œê°„ ë¡œë“œ â”€â”€
var _assignedHwUnsub = null;
async function loadAssignedHomework() {
  var listEl = document.getElementById('hw-assigned-list');
  if (!listEl) return;
  if (_assignedHwUnsub) { _assignedHwUnsub(); _assignedHwUnsub = null; }
  try {
    var user = window._currentUser;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    // ì „ì²´ ëŒ€ìƒ or ë‚˜ì—ê²Œë§Œ ë³´ë‚¸ ìˆ™ì œ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
    var qAll = mod.query(mod.collection(window._db,'assignments'), mod.where('target','==','all'));
    var qMe  = mod.query(mod.collection(window._db,'assignments'), mod.where('target','==', user.uid));

    var classEmoji = { 'ì„±ê²½ì˜ì–´':'ğŸ“–','íšŒí™”':'ğŸ’¬','ê¸€ì“°ê¸°':'âœï¸','ì½”ì¹­':'ğŸŒ±','í‚¤ì¦ˆ':'ğŸŒ¿','ì „ì²´':'ğŸ“¢' };

    async function render() {
      var [snapAll, snapMe] = await Promise.all([mod.getDocs(qAll), mod.getDocs(qMe)]);
      var docs = [];
      snapAll.forEach(function(ds){ docs.push({id:ds.id, data:ds.data()}); });
      snapMe.forEach(function(ds){ docs.push({id:ds.id, data:ds.data()}); });
      // ì´ë¯¸ ì œì¶œí•œ ê²ƒ í•„í„°
      var submittedSnap = await mod.getDocs(mod.query(
        mod.collection(window._db,'homework'), mod.where('studentUid','==',user.uid)
      ));
      var submittedTitles = new Set();
      submittedSnap.forEach(function(ds){ submittedTitles.add(ds.data().hwTitle); });

      docs.sort(function(a,b){
        return (b.data.createdAt?b.data.createdAt.seconds:0)-(a.data.createdAt?a.data.createdAt.seconds:0);
      });

      if (docs.length === 0) { listEl.innerHTML = ''; updatePendingBadge(); return; }

      var html = '';
      docs.forEach(function(item) {
        var d = item.data;
        var isDone = submittedTitles.has(d.title);
        var emoji = classEmoji[d.className] || 'ğŸ“';
        var dueStr = d.dueDate ? 'ë§ˆê° <span>' + d.dueDate + '</span>' : '';
        html += '<div class="hw-card" data-hw="' + (isDone?'done':'pending') + '" data-assigned="' + item.id + '">'
          + '<div class="hw-top"><div class="hw-class">' + emoji + ' ' + d.className + '</div>'
          + '<span class="hw-status ' + (isDone?'done':'pending') + '">' + (isDone?'âœ“ ì œì¶œ ì™„ë£Œ':'ë¯¸ì œì¶œ') + '</span></div>'
          + '<div class="hw-title">' + d.title + '</div>'
          + (d.desc ? '<div class="hw-desc">' + d.desc + '</div>' : '')
          + (dueStr ? '<div class="hw-due">' + dueStr + '</div>' : '')
          + (isDone
            ? '<button class="hw-submit-btn done-btn" disabled>âœ“ ì œì¶œ ì™„ë£Œ</button>'
            : '<button class="hw-submit-btn" onclick="openSubmitModal(\'' + d.title.replace(/'/g,"\\'") + '\')">ğŸ“ ì œì¶œí•˜ê¸°</button>')
          + '</div>';
      });
      listEl.innerHTML = html;
      updatePendingBadge();
    }

    await render();
    // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ìƒˆ ìˆ™ì œ ì¶”ê°€ ì‹œ)
    _assignedHwUnsub = mod.onSnapshot(qAll, function(){ render(); });
  } catch(err) { console.error(err); }
}

function updatePendingBadge() {
  var pending = document.querySelectorAll('#hw-pending-section .hw-card[data-hw="pending"]').length;
  var tabBadge = document.getElementById('pendingBadge');
  var navBadge = document.getElementById('navHwBadge');
  if (tabBadge) tabBadge.textContent = pending;
  if (navBadge) {
    navBadge.textContent = pending;
    navBadge.style.display = pending > 0 ? 'inline' : 'none';
  }
}

// â”€â”€ ìˆ˜ê°• ì‹ ì²­ ëª¨ë‹¬ â”€â”€
function openEnrollModal(classKey, className) {
  document.getElementById('modalTitle').textContent = 'ğŸ“‹ ìˆ˜ê°• ì‹ ì²­';
  document.getElementById('modalBody').innerHTML = `
    <div style="background:var(--cream);border-radius:12px;padding:.8rem 1rem;margin-bottom:1rem;">
      <div style="font-size:.72rem;color:var(--gray);margin-bottom:.2rem;">ì‹ ì²­ ìˆ˜ì—…</div>
      <div style="font-size:1rem;font-weight:600;font-family:'Cormorant Garamond',serif;">${className}</div>
    </div>
    <input class="m-input" id="enrollPhone" type="tel" placeholder="ì—°ë½ì²˜ (ì„ íƒ)">
    <select class="m-input" id="enrollMode">
      <option value="ì˜¨ë¼ì¸">ğŸ’» ì˜¨ë¼ì¸ (Zoom)</option>
      <option value="ëŒ€ë©´">ğŸ« ëŒ€ë©´</option>
      <option value="ìƒê´€ì—†ìŒ">âœ¨ ìƒê´€ì—†ìŒ</option>
    </select>
    <textarea class="m-input" id="enrollNote" rows="3" placeholder="ë‚¨ê¸°ì‹¤ ë§ì”€ (ì„ íƒ)"></textarea>
    <button class="m-btn" id="enrollSubmitBtn" onclick="submitEnroll('${classKey}','${className}')">ì‹ ì²­í•˜ê¸° â†’</button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ìˆ˜ê°• ì‹ ì²­ Firebase ì €ì¥ â”€â”€
async function submitEnroll(classKey, className) {
  var btn = document.getElementById('enrollSubmitBtn');
  if (btn) { btn.textContent = 'ì‹ ì²­ ì¤‘...'; btn.disabled = true; }
  try {
    var user = window._currentUser;
    var phone = (document.getElementById('enrollPhone') || {}).value || '';
    var mode = (document.getElementById('enrollMode') || {}).value || 'ì˜¨ë¼ì¸';
    var note = (document.getElementById('enrollNote') || {}).value || '';

    // ì¤‘ë³µ ì‹ ì²­ ë°©ì§€
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var existing = await mod.getDocs(mod.query(
      mod.collection(window._db, 'enrollments'),
      mod.where('studentUid', '==', user.uid),
      mod.where('classKey', '==', classKey)
    ));
    if (!existing.empty) {
      closeModal();
      showToast('ì´ë¯¸ ì‹ ì²­í•œ ìˆ˜ì—…ì´ì—ìš”');
      return;
    }

    await window._addDoc(window._collection(window._db, 'enrollments'), {
      studentUid: user.uid,
      studentName: user.name,
      studentEmail: user.email,
      classKey: classKey,
      className: className,
      phone: phone,
      mode: mode,
      note: note,
      status: 'pending',
      appliedAt: window._serverTimestamp()
    });

    closeModal();
    showToast('âœ… ì‹ ì²­ ì™„ë£Œ! ì½”ì¹˜ë‹˜ì´ 1-2ì¼ ë‚´ ì—°ë½ë“œë¦´ê²Œìš” ğŸ’Œ');
    applyEnrollStyle(classKey, 'pending');
  } catch(err) {
    showToast('ì‹ ì²­ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    if (btn) { btn.textContent = 'ì‹ ì²­í•˜ê¸° â†’'; btn.disabled = false; }
    console.error(err);
  }
}

// â”€â”€ ì‹ ì²­/í™•ì • ìƒíƒœì— ë”°ë¼ ì¹´ë“œ UI ë³€ê²½ â”€â”€
function applyEnrollStyle(classKey, status) {
  var badge = document.getElementById('badge-' + classKey);
  var btn   = document.getElementById('btn-'   + classKey);
  if (!badge || !btn) return;

  if (status === 'pending') {
    badge.textContent = 'â³ ì‹ ì²­ ëŒ€ê¸°';
    badge.className   = 'cc-badge';
    badge.style.cssText = 'background:var(--gold-light);color:#8a6a30;';
    btn.textContent   = 'â³ ì‹ ì²­ ì™„ë£Œ Â· í™•ì¸ ëŒ€ê¸° ì¤‘';
    btn.className     = 'cc-btn';
    btn.style.cssText = 'background:var(--gold-light);color:#8a6a30;cursor:default;';
    btn.onclick       = null;

  } else if (status === 'confirmed') {
    badge.textContent = 'âœ“ ìˆ˜ê°• í™•ì •';
    badge.className   = 'cc-badge';
    badge.style.cssText = 'background:var(--sage-light);color:var(--sage);';
    btn.textContent   = 'âœ“ ìˆ˜ê°• í™•ì • Â· ìˆ˜ì—… ì‹œì‘ ì˜ˆì •';
    btn.className     = 'cc-btn';
    btn.style.cssText = 'background:var(--sage-light);color:var(--sage);cursor:default;';
    btn.onclick       = null;

  } else if (status === 'active') {
    badge.textContent = 'ğŸ“ ìˆ˜ê°• ì¤‘';
    badge.className   = 'cc-badge enrolled';
    badge.style.cssText = '';
    btn.textContent   = 'ğŸ“ ìˆ˜ê°• ì¤‘ Â· ìë£Œ ë³´ê¸°';
    btn.className     = 'cc-btn enrolled-btn';
    btn.style.cssText = '';
    btn.onclick       = function() { openClassMaterials(classKey, (_classNames[classKey] || classKey)); };
  }
}

// â”€â”€ ë¡œê·¸ì¸ ì‹œ ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ ë³µì› + ë‚ ì§œ ê¸°ë°˜ ìë™ active ì „í™˜ â”€â”€
async function restoreEnrollments() {
  try {
    var user = window._currentUser;
    if (!user) return;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var today = new Date().toISOString().split('T')[0];

    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'enrollments'),
      mod.where('studentUid', '==', user.uid)
    ));

    var updates = [];
    snap.forEach(function(ds) {
      var d = ds.data();
      var effectiveStatus = d.status;

      // confirmed ìƒíƒœì´ê³  ì‹œì‘ì¼ì´ ì˜¤ëŠ˜ ì´í•˜ë©´ â†’ activeë¡œ ìë™ ì „í™˜
      if (d.status === 'confirmed' && d.startDate && d.startDate <= today) {
        effectiveStatus = 'active';
        updates.push(mod.updateDoc(mod.doc(window._db, 'enrollments', ds.id), { status: 'active' }));
      }

      applyEnrollStyle(d.classKey, effectiveStatus);
    });

    // ìë™ ì „í™˜ ì—…ë°ì´íŠ¸ ì¼ê´„ ì‹¤í–‰
    if (updates.length > 0) await Promise.all(updates);

  } catch(err) { console.error(err); }
}

// â”€â”€ ê³¼ì œ ì‹¤ì œ ì œì¶œ (Firebase ì €ì¥) â”€â”€
async function submitHomework(hwTitle) {
  var text = (document.getElementById('hwText') || {}).value || '';
  text = text.trim();
  if (!text) { showToast('ê³¼ì œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('hwSubmitBtn');
  if (btn) { btn.textContent = 'ì œì¶œ ì¤‘...'; btn.disabled = true; }
  try {
    var user = window._currentUser;
    await window._addDoc(window._collection(window._db, 'homework'), {
      studentUid: user.uid,
      studentName: user.name,
      hwTitle: hwTitle,
      text: text,
      fileUrl: null,
      fileName: null,
      status: 'submitted',
      feedback: null,
      submittedAt: window._serverTimestamp()
    });
    closeModal();
    showToast('âœ… ì œì¶œ ì™„ë£Œ! ì œì¶œ ì™„ë£Œ íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš” ğŸ’Œ');

    // ì½”ì¹˜ê°€ ë‚¸ ìˆ™ì œ ëª©ë¡ ìƒíƒœ ê°±ì‹ 
    if (typeof loadAssignedHomework === 'function') loadAssignedHomework();

    // í•´ë‹¹ ì¹´ë“œë¥¼ ì œì¶œ ì™„ë£Œ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.hw-card[data-hw="pending"]').forEach(function(card) {
      var titleEl = card.querySelector('.hw-title');
      if (titleEl && titleEl.textContent.includes(hwTitle.replace(' í•„ì‚¬','').replace(' ë…¹ìŒ',''))) {
        card.dataset.hw = 'done';
        var statusEl = card.querySelector('.hw-status');
        if (statusEl) { statusEl.className = 'hw-status done'; statusEl.textContent = 'âœ“ ì œì¶œ ì™„ë£Œ'; }
        var submitBtn = card.querySelector('.hw-submit-btn');
        if (submitBtn) { submitBtn.className = 'hw-submit-btn done-btn'; submitBtn.textContent = 'âœ“ ì œì¶œ ì™„ë£Œ'; submitBtn.onclick = null; }
      }
    });
    var remaining = document.querySelectorAll('.hw-card[data-hw="pending"]').length;
    var pendingBadge = document.getElementById('pendingBadge');
    if (pendingBadge) pendingBadge.textContent = remaining;
    updatePendingBadge();
  } catch(err) {
    console.error('ì œì¶œ ì—ëŸ¬:', err);
    showToast('ì œì¶œì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    if (btn) { btn.textContent = 'ì œì¶œí•˜ê¸° â†’'; btn.disabled = false; }
  }
}

function openSubmitModal(hwTitle) {
  const overlay = document.getElementById('modalOverlay');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  title.textContent = 'ğŸ“ ê³¼ì œ ì œì¶œ';
  body.innerHTML = `
    <p style="font-size:.88rem;font-weight:600;margin-bottom:.8rem;">${hwTitle}</p>
    <textarea id="hwText" class="m-input" placeholder="ê³¼ì œ ë‚´ìš©ì„ ì—¬ê¸°ì— ì¨ì£¼ì„¸ìš”..." rows="6"></textarea>
    <button class="m-btn" id="hwSubmitBtn" onclick="submitHomework('${hwTitle}')">ì œì¶œí•˜ê¸° â†’</button>`;
  overlay.classList.add('open');
}

function openModal(type, data) {
  const overlay = document.getElementById('modalOverlay');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');

  if (type === 'submit') {
    title.textContent = 'ğŸ“ ê³¼ì œ ì œì¶œ';
    body.innerHTML = `
      <p style="font-size:0.82rem; color:var(--gray); margin-bottom:1rem; font-family:'Noto Serif KR',serif; font-weight:300;">${data}</p>
      <textarea class="m-input" placeholder="ê³¼ì œ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì²¨ë¶€í•˜ì„¸ìš”..." rows="4"></textarea>
      <div style="border:2px dashed var(--light); border-radius:12px; padding:1.5rem; text-align:center; margin-bottom:0.8rem; cursor:pointer;" onclick="showToast('íŒŒì¼ ì„ íƒ ì°½ì´ ì—´ë¦½ë‹ˆë‹¤')">
        <div style="font-size:1.5rem; margin-bottom:0.3rem;">ğŸ“</div>
        <div style="font-size:0.78rem; color:var(--gray);">íŒŒì¼ ì²¨ë¶€ (ì‚¬ì§„, ìŒì„±, PDF)</div>
      </div>
      <button class="m-btn" onclick="closeModal(); showToast('âœ… ì œì¶œ ì™„ë£Œ! ì½”ì¹˜ë‹˜ì´ í™•ì¸ í›„ í”¼ë“œë°±ì„ ë“œë ¤ìš”.')">ì œì¶œí•˜ê¸°</button>`;
  } else if (type === 'enroll') {
    title.textContent = 'ìˆ˜ê°• ì‹ ì²­';
    body.innerHTML = `
      <div style="background:var(--cream); border-radius:12px; padding:1rem; margin-bottom:1rem; font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-weight:600;">${data}</div>
      <input class="m-input" type="text" placeholder="ì´ë¦„">
      <input class="m-input" type="text" placeholder="ì—°ë½ì²˜">
      <select class="m-input">
        <option>ì˜¨ë¼ì¸ (Zoom)</option>
        <option>ëŒ€ë©´</option>
        <option>ìƒê´€ì—†ìŒ</option>
      </select>
      <textarea class="m-input" rows="2" placeholder="ë‚¨ê¸°ì‹¤ ë§ì”€ (ì„ íƒ)"></textarea>
      <button class="m-btn" onclick="closeModal(); showToast('âœ… ì‹ ì²­ ì™„ë£Œ! 1-2ì¼ ë‚´ ì—°ë½ë“œë¦´ê²Œìš” ğŸ’Œ')">ì‹ ì²­í•˜ê¸°</button>`;
  } else if (type === 'feedback') {
    title.textContent = `ğŸ’Œ ${data}ë‹˜ê»˜ í”¼ë“œë°±`;
    body.innerHTML = `
      <textarea class="m-input" rows="5" placeholder="ì˜¤ëŠ˜ ìˆ˜ì—… í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
      <button class="m-btn" onclick="closeModal(); showToast('âœ… í”¼ë“œë°±ì„ ì „ì†¡í–ˆì–´ìš”!')">ì „ì†¡í•˜ê¸°</button>`;
  } else if (type === 'write') {
    var isCoach = window._currentUser && window._currentUser.role === 'coach';
    title.textContent = isCoach ? 'ğŸ“£ ê³µì§€ / ì‘ì› ê¸€ì“°ê¸°' : 'âœï¸ ê¸€ ì“°ê¸°';
    var placeholder = isCoach
      ? 'í•™ìƒë“¤ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ê³µì§€ë‚˜ ì‘ì› ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”...'
      : 'ì˜¤ëŠ˜ì˜ ì˜ì–´ í•œë§ˆë””, ë‚˜ëˆ”, ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ ì¨ì£¼ì„¸ìš”...';
    var categoryOptions = isCoach
      ? '<option value="ê³µì§€">ğŸ“£ ê³µì§€</option><option value="ì‘ì›">ğŸ’› ì‘ì›</option><option value="ì„±ê²½ì˜ì–´">ğŸ“– ì„±ê²½ì˜ì–´</option><option value="íšŒí™”">ğŸ’¬ íšŒí™”</option>'
      : '<option value="ì„±ê²½ì˜ì–´">ğŸ“– ì„±ê²½ì˜ì–´</option><option value="íšŒí™”">ğŸ’¬ íšŒí™”</option><option value="ì¼ë°˜">ğŸŒ± ì¼ë°˜</option><option value="ì§ˆë¬¸">â“ ì§ˆë¬¸</option>';
    body.innerHTML = `
      <select class="m-input" id="postCategory">${categoryOptions}</select>
      <textarea class="m-input" id="postContent" rows="5" placeholder="${placeholder}"></textarea>
      <button class="m-btn" id="postSubmitBtn" onclick="submitPost()">ê²Œì‹œí•˜ê¸° â†’</button>`;
  }

  overlay.classList.add('open');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

// ì•Œë¦¼ ì„¤ì • ëª¨ë‹¬
function openNotificationSettings() {
  const overlay = document.getElementById('modalOverlay');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  title.textContent = 'ğŸ”” ì•Œë¦¼ ì„¤ì •';
  body.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:.8rem;margin-bottom:1.2rem;">
      <label style="display:flex;justify-content:space-between;align-items:center;font-size:.88rem;">
        ìˆ˜ì—… ì‹œì‘ 30ë¶„ ì „ ì•Œë¦¼
        <input type="checkbox" checked style="width:18px;height:18px;accent-color:var(--rose);">
      </label>
      <label style="display:flex;justify-content:space-between;align-items:center;font-size:.88rem;">
        ìˆ™ì œ ë§ˆê° ì•Œë¦¼
        <input type="checkbox" checked style="width:18px;height:18px;accent-color:var(--rose);">
      </label>
      <label style="display:flex;justify-content:space-between;align-items:center;font-size:.88rem;">
        ì½”ì¹˜ í”¼ë“œë°± ì•Œë¦¼
        <input type="checkbox" checked style="width:18px;height:18px;accent-color:var(--rose);">
      </label>
      <label style="display:flex;justify-content:space-between;align-items:center;font-size:.88rem;">
        ì»¤ë®¤ë‹ˆí‹° ìƒˆ ê¸€ ì•Œë¦¼
        <input type="checkbox" style="width:18px;height:18px;accent-color:var(--rose);">
      </label>
    </div>
    <button class="m-btn" onclick="closeModal(); showToast('âœ… ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆì–´ìš”!')">ì €ì¥í•˜ê¸°</button>`;
  overlay.classList.add('open');
}

// ì¤Œ ë§í¬ ì—´ê¸° (ì½”ì¹˜ë‹˜ì´ ì‹¤ì œ ë§í¬ë¡œ êµì²´í•˜ì„¸ìš”)
function openZoom() {
  const zoomUrl = 'https://us05web.zoom.us/j/81258447771?pwd=1fDkUQB4yr5hQz7l0bfoDvvfxbKp8K.1';
  window.open(zoomUrl, '_blank');
}

let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ ì½”ì¹˜: ì‹¤ì œ ê°€ì… í•™ìƒ ëª©ë¡ ë¡œë“œ (ìµœì‹  ê°€ì…ìˆœ ìƒë‹¨) â”€â”€
async function loadCoachStudents() {
  var listEl = document.getElementById('coach-student-list');
  if (!listEl) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'users'),
      mod.where('role', '==', 'student')
    ));
    if (snap.empty) { listEl.innerHTML = ''; return; }

    var students = [];
    snap.forEach(function(ds) { students.push({ uid: ds.id, data: ds.data() }); });
    // ìµœì‹  ê°€ì…ìˆœ (ë‚´ë¦¼ì°¨ìˆœ)
    students.sort(function(a, b) {
      return (b.data.createdAt ? b.data.createdAt.seconds : 0)
           - (a.data.createdAt ? a.data.createdAt.seconds : 0);
    });

    var avatarColors = [
      'linear-gradient(135deg,var(--sage-light),var(--gold-light))',
      'linear-gradient(135deg,var(--rose-light),var(--gold-light))',
      'linear-gradient(135deg,var(--gold-light),var(--sage-light))',
      'linear-gradient(135deg,var(--cream),var(--rose-light))'
    ];

    var html = '';
    for (var i = 0; i < students.length; i++) {
      var s = students[i]; var d = s.data;
      var color = avatarColors[i % avatarColors.length];
      var initial = (d.name || '?').charAt(0);

      var [enrollConfirmedSnap, enrollActiveSnap, pendingSnap, hwSnap] = await Promise.all([
        mod.getDocs(mod.query(mod.collection(window._db,'enrollments'), mod.where('studentUid','==',s.uid), mod.where('status','==','confirmed'))),
        mod.getDocs(mod.query(mod.collection(window._db,'enrollments'), mod.where('studentUid','==',s.uid), mod.where('status','==','active'))),
        mod.getDocs(mod.query(mod.collection(window._db,'enrollments'), mod.where('studentUid','==',s.uid), mod.where('status','==','pending'))),
        mod.getDocs(mod.query(mod.collection(window._db,'homework'),    mod.where('studentUid','==',s.uid)))
      ]);

      var classes = [];
      enrollActiveSnap.forEach(function(e) { classes.push('ğŸ“ ' + e.data().className); });
      enrollConfirmedSnap.forEach(function(e) { classes.push('âœ“ ' + e.data().className); });

      var classLabel = classes.length > 0 ? classes.join(' Â· ')
        : (pendingSnap.size > 0 ? 'â³ ì‹ ì²­ ëŒ€ê¸° ' + pendingSnap.size + 'ê°œ' : 'ìˆ˜ê°• ìˆ˜ì—… ì—†ìŒ');
      var joinDate = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '';

      html += '<div class="student-card">'
        + '<div class="s-avatar" style="background:' + color + '">' + initial + '</div>'
        + '<div class="s-info">'
        + '<div class="s-name">' + (d.name||'ì´ë¦„ ì—†ìŒ')
        + '<span style="font-size:.62rem;color:var(--sage);background:var(--sage-light);border-radius:20px;padding:.1rem .5rem;margin-left:.4rem;">ì‹ ê·œ</span></div>'
        + '<div class="s-class">' + classLabel + '</div>'
        + '<div class="s-progress"><div class="s-progress-text"><span>ì œì¶œ ê³¼ì œ ' + hwSnap.size + 'ê°œ</span><span style="font-size:.65rem;color:var(--gray);">ê°€ì… ' + joinDate + '</span></div></div>'
        + '</div>'
        + '<button class="s-action" onclick="openManualFeedbackForStudent(\'' + s.uid + '\',\'' + (d.name||'') + '\')">í”¼ë“œë°±</button>'
        + '</div>';
    }

    // ìƒë‹¨ í†µê³„ ì—…ë°ì´íŠ¸
    var statEls = document.querySelectorAll('.cs-num');
    if (statEls[0]) statEls[0].textContent = 3 + students.length;
    listEl.innerHTML = html;
  } catch(err) { console.error(err); listEl.innerHTML = ''; }
}

// â”€â”€ ë‚´ ì •ë³´: í•™ìŠµ ìë£Œ (ìˆ˜ê°• í™•ì • ìˆ˜ì—… ê¸°ë°˜) â”€â”€
async function openMyMaterials() {
  document.getElementById('modalTitle').textContent = 'ğŸ“š ë‚´ í•™ìŠµ ìë£Œ';
  document.getElementById('modalBody').innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  document.getElementById('modalOverlay').classList.add('open');

  try {
    var user = window._currentUser;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'enrollments'),
      mod.where('studentUid', '==', user.uid)
    ));

    if (snap.empty) {
      document.getElementById('modalBody').innerHTML = `
        <div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">
          ì•„ì§ ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…ì´ ì—†ì–´ìš” ğŸŒ±<br>
          <span style="font-size:.78rem;">ìˆ˜ì—…ì„ ì‹ ì²­í•˜ë©´ ìë£Œê°€ ì—¬ê¸°ì— í‘œì‹œë¼ìš”</span>
        </div>`;
      return;
    }

    // ìˆ˜ì—…ë³„ ìë£Œ ëª©ë¡
    var materialMap = {
      'writing':  { emoji:'âœï¸', items:['ì˜ì–´ ê¸€ì“°ê¸° ì›Œí¬ì‹œíŠ¸ 1-4ì£¼ì°¨', 'ì—ì„¸ì´ êµ¬ì¡° ê°€ì´ë“œ PDF', 'ì¼ê¸° ì“°ê¸° í…œí”Œë¦¿', 'êµì • ì˜ˆì‹œ ëª¨ìŒ'] },
      'coaching': { emoji:'ğŸŒ±', items:['ìì‹ ê° ë¹Œë”© ì›Œí¬ë¶', 'í•™ìŠµ ëª©í‘œ ì„¤ì • ì‹œíŠ¸', '1:1 ì½”ì¹­ í”¼ë“œë°± ê¸°ë¡ì§€'] },
      'kids':     { emoji:'ğŸŒ¿', items:['íŒŒë‹‰ìŠ¤ ì›Œí¬ì‹œíŠ¸', 'ì˜ì–´ ë™ìš” ê°€ì‚¬ì§‘', 'ìŠ¤í‹°ì»¤ ë³´ìƒí‘œ', 'í•™ë¶€ëª¨ ê°€ì´ë“œ'] },
      'bible':    { emoji:'ğŸ“–', items:['John 3ì¥ ì˜ì–´ ë³¸ë¬¸', 'ë§ì”€ í•„ì‚¬ ë…¸íŠ¸', 'ì„±ê²½ì˜ì–´ ë‹¨ì–´ì¥'] },
      'speaking': { emoji:'ğŸ’¬', items:['íšŒí™” í‘œí˜„ 100ì„ ', 'ë°œìŒ êµì • ê°€ì´ë“œ', 'ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸ ëª¨ìŒ'] }
    };

    var html = '';
    snap.forEach(function(ds) {
      var d = ds.data();
      var status = d.status;
      var info = materialMap[d.classKey] || { emoji:'ğŸ“„', items:['ìˆ˜ì—… ìë£Œ'] };

      var statusBadge =
        status === 'active'    ? '<span style="font-size:.65rem;background:var(--sage-light);color:var(--sage);border-radius:20px;padding:.1rem .5rem;margin-left:.4rem;">ğŸ“ ìˆ˜ê°• ì¤‘</span>'
        : status === 'confirmed' ? '<span style="font-size:.65rem;background:#e8f4e8;color:#5a9a60;border-radius:20px;padding:.1rem .5rem;margin-left:.4rem;">âœ“ ìˆ˜ê°• í™•ì •</span>'
        : '<span style="font-size:.65rem;background:var(--gold-light);color:#8a6a30;border-radius:20px;padding:.1rem .5rem;margin-left:.4rem;">â³ ì‹ ì²­ ëŒ€ê¸°</span>';

      var startInfo = d.startDate
        ? '<div style="font-size:.68rem;color:var(--gray);margin-bottom:.4rem;">ğŸ“… ìˆ˜ì—… ì‹œì‘ì¼: ' + d.startDate + '</div>'
        : '';

      html += '<div style="margin-bottom:1rem;">'
        + '<div style="font-size:.88rem;font-weight:600;margin-bottom:.3rem;">' + info.emoji + ' ' + d.className + statusBadge + '</div>'
        + startInfo;

      if (status === 'active') {
        html += '<div style="font-size:.75rem;color:var(--gray);margin-bottom:.4rem;">ìˆ˜ì—… ìë£Œë¥¼ ëˆŒëŸ¬ ë°”ë¡œ ì—´ì–´ë³´ì„¸ìš”</div>'
          + '<button class="mat-open-btn" data-classkey="' + d.classKey + '" data-classname="' + d.className + '" style="width:100%;background:var(--sage-light);color:var(--sage);border:none;border-radius:10px;padding:.6rem;font-size:.8rem;font-family:\'DM Sans\',sans-serif;cursor:pointer;">ğŸ“‚ ìë£Œ ë³´ê¸°</button>';
      } else if (status === 'confirmed') {
        html += '<div style="font-size:.78rem;color:#5a9a60;padding:.5rem;background:#e8f4e8;border-radius:8px;">ìˆ˜ì—… ì‹œì‘ì¼ì— ìë£Œê°€ ê³µê°œë¼ìš” ğŸ“…</div>';
      } else {
        html += '<div style="font-size:.78rem;color:var(--gray);padding:.5rem;background:var(--cream);border-radius:8px;">ìˆ˜ê°• í™•ì • í›„ ìë£Œê°€ ê³µê°œë¼ìš” ğŸ”’</div>';
      }
      html += '</div>';
    });

    document.getElementById('modalBody').innerHTML = html;

    // data ì†ì„±ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì´ë²¤íŠ¸ ë°”ì¸ë”© (onclick ë¬¸ìì—´ íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€)
    document.querySelectorAll('.mat-open-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        openClassMaterials(this.dataset.classkey, this.dataset.classname);
      });
    });

  } catch(err) {
    document.getElementById('modalBody').innerHTML = '<div style="color:var(--rose);text-align:center;padding:1rem;font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

// â”€â”€ ì½”ì¹˜: ì»¤ë®¤ë‹ˆí‹° ìƒˆ ê¸€ ì‹¤ì‹œê°„ â”€â”€
var _coachCommunityUnsub = null;
async function loadCoachCommunity() {
  var listEl = document.getElementById('coach-community-list');
  if (!listEl) return;
  if (_coachCommunityUnsub) { _coachCommunityUnsub(); _coachCommunityUnsub = null; }
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    _coachCommunityUnsub = mod.onSnapshot(mod.collection(window._db, 'posts'), function(snap) {
      if (snap.empty) {
        listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ì–´ìš”</div>';
        return;
      }
      var docs = [];
      snap.forEach(function(ds) { docs.push(ds.data()); });
      docs.sort(function(a, b) {
        return (b.createdAt ? b.createdAt.seconds : 0) - (a.createdAt ? a.createdAt.seconds : 0);
      });
      var categoryEmoji = { 'ì„±ê²½ì˜ì–´':'ğŸ“–','íšŒí™”':'ğŸ’¬','ì¼ë°˜':'ğŸŒ±','ì§ˆë¬¸':'â“' };
      var html = '';
      docs.forEach(function(d) {
        var t = d.createdAt ? timeAgo(new Date(d.createdAt.seconds * 1000)) : 'ë°©ê¸ˆ ì „';
        var emoji = categoryEmoji[d.category] || 'ğŸŒ±';
        html += '<div class="post-card" style="margin-bottom:.6rem;">'
          + '<div class="post-top">'
          + '<div class="post-avatar" style="background:linear-gradient(135deg,var(--rose-light),var(--gold-light));width:28px;height:28px;font-size:.75rem;">' + (d.authorName||'?').charAt(0) + '</div>'
          + '<div><div class="post-user" style="font-size:.82rem;">' + (d.authorName||'ìµëª…') + '</div></div>'
          + '<span class="post-badge-tag" style="font-size:.65rem;">' + emoji + ' ' + (d.category||'') + '</span>'
          + '<div class="post-time">' + t + '</div>'
          + '</div>'
          + '<div class="post-content" style="font-size:.82rem;">' + d.content + '</div>'
          + '<div style="font-size:.72rem;color:var(--gray);margin-top:.3rem;">â¤ï¸ ' + (d.likes||0) + '</div>'
          + '</div>';
      });
      listEl.innerHTML = html;
    });
  } catch(err) { console.error(err); }
}

// â”€â”€ ì½”ì¹˜: ëª©ì—… í•™ìƒ í”¼ë“œë°± (ì´ë¦„ ê¸°ë°˜) â”€â”€
function openMockStudentFeedback(name) {
  openDirectFeedbackModal(null, name);
}

// â”€â”€ ì½”ì¹˜: ì‹¤ì œ í•™ìƒ í”¼ë“œë°± (UID ê¸°ë°˜) â”€â”€
function openManualFeedbackForStudent(uid, name) {
  openDirectFeedbackModal(uid, name);
}

// â”€â”€ ê³µí†µ: ì§ì ‘ í”¼ë“œë°± ëª¨ë‹¬ â”€â”€
async function openDirectFeedbackModal(uid, name) {
  document.getElementById('modalTitle').textContent = 'âœï¸ ' + name + 'ë‹˜ê»˜ í”¼ë“œë°±';

  // ê¸°ì¡´ í”¼ë“œë°± íˆìŠ¤í† ë¦¬ ë¯¸ë¦¬ ë¡œë“œ
  var historyHtml = '<div style="font-size:.72rem;color:var(--gray);margin-bottom:.4rem;">ì´ì „ í”¼ë“œë°±</div>';
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var q;
    if (uid) {
      q = mod.query(mod.collection(window._db, 'directFeedbacks'),
        mod.where('studentUid', '==', uid));
    } else {
      q = mod.query(mod.collection(window._db, 'directFeedbacks'),
        mod.where('studentName', '==', name));
    }
    var snap = await mod.getDocs(q);
    if (snap.empty) {
      historyHtml += '<div style="font-size:.75rem;color:var(--gray);padding:.4rem 0;">ì•„ì§ ì—†ì–´ìš”</div>';
    } else {
      var items = [];
      snap.forEach(function(ds) { items.push(ds.data()); });
      items.sort(function(a, b) {
        return (b.createdAt ? b.createdAt.seconds : 0) - (a.createdAt ? a.createdAt.seconds : 0);
      });
      items.slice(0, 3).forEach(function(d) {
        var t = d.createdAt ? timeAgo(new Date(d.createdAt.seconds * 1000)) : '';
        historyHtml += '<div style="background:var(--cream);border-radius:8px;padding:.5rem .8rem;margin-bottom:.4rem;">'
          + '<div style="font-size:.72rem;color:var(--gray);">' + t + '</div>'
          + '<div style="font-size:.8rem;line-height:1.6;">' + d.feedback + '</div>'
          + '</div>';
      });
    }
  } catch(e) { historyHtml = ''; }

  document.getElementById('modalBody').innerHTML = `
    <div style="max-height:160px;overflow-y:auto;margin-bottom:.8rem;padding:.6rem;background:var(--warm);border-radius:10px;">${historyHtml}</div>
    <div style="font-size:.72rem;color:var(--gray);margin-bottom:.4rem;">ìƒˆ í”¼ë“œë°± ì‘ì„±</div>
    <textarea id="directFbText" class="m-input" rows="4" placeholder="í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”...&#10;í•™ìƒ í™ˆ í™”ë©´ì— ë°”ë¡œ í‘œì‹œë¼ìš”"></textarea>
    <button class="m-btn" id="directFbBtn" onclick="sendDirectFeedback('${uid||''}','${name}')">ì „ì†¡í•˜ê¸° â†’</button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ì§ì ‘ í”¼ë“œë°± ì €ì¥ â”€â”€
async function sendDirectFeedback(uid, name) {
  var text = (document.getElementById('directFbText') || {}).value.trim();
  if (!text) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('directFbBtn');
  if (btn) { btn.textContent = 'ì „ì†¡ ì¤‘...'; btn.disabled = true; }
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.addDoc(mod.collection(window._db, 'directFeedbacks'), {
      studentUid: uid || null,
      studentName: name,
      feedback: text,
      createdAt: mod.serverTimestamp()
    });
    closeModal();
    showToast('âœ… ' + name + 'ë‹˜ê»˜ í”¼ë“œë°±ì„ ì „ì†¡í–ˆì–´ìš”!');
  } catch(err) {
    showToast('ì „ì†¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    if (btn) { btn.textContent = 'ì „ì†¡í•˜ê¸° â†’'; btn.disabled = false; }
    console.error(err);
  }
}
async function loadCoachEnrollments() {
  var listEl = document.getElementById('coach-enroll-list');
  if (!listEl) return;
  listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.collection(window._db, 'enrollments'));
    if (snap.empty) {
      listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</div>';
      return;
    }
    var docs = [];
    snap.forEach(function(ds) { docs.push({ id: ds.id, data: ds.data() }); });
    docs.sort(function(a, b) {
      var ta = a.data.appliedAt ? a.data.appliedAt.seconds : 0;
      var tb = b.data.appliedAt ? b.data.appliedAt.seconds : 0;
      return tb - ta;
    });
    var html = '';
    docs.forEach(function(item) {
      var d = item.data; var docId = item.id;
      var isPending = d.status === 'pending';
      var isActive  = d.status === 'active';
      var date = d.appliedAt ? new Date(d.appliedAt.seconds * 1000).toLocaleDateString('ko-KR') : 'ë°©ê¸ˆ';
      var statusLabel = isPending ? 'â³ ëŒ€ê¸° ì¤‘' : (isActive ? 'ğŸ“ ìˆ˜ê°• ì¤‘' : 'âœ“ í™•ì •');
      var statusClass = isPending ? 'pending' : 'done';

      // ì‹œì‘ì¼ í‘œì‹œ í–‰
      var startRow = '';
      if (!isPending) {
        var startStr = d.startDate || 'ë¯¸ì§€ì •';
        startRow = '<div style="display:flex;align-items:center;gap:.5rem;margin:.4rem 0;">'
          + '<span style="font-size:.78rem;color:var(--gray);">ğŸ“… ìˆ˜ì—… ì‹œì‘ì¼: <b>' + startStr + '</b></span>'
          + '<button onclick="openEditStartDateModal(\'' + docId + '\',\'' + startStr + '\')" '
          + 'style="font-size:.65rem;background:none;border:1px solid var(--light);border-radius:20px;padding:.15rem .5rem;cursor:pointer;color:var(--gray);">ìˆ˜ì •</button>'
          + '</div>';
      }

      html += '<div class="hw-card">'
        + '<div class="hw-top">'
        + '<div class="hw-class">ğŸ“ ' + (d.studentName || 'í•™ìƒ') + '</div>'
        + '<span class="hw-status ' + statusClass + '">' + statusLabel + '</span>'
        + '</div>'
        + '<div class="hw-title" style="font-size:.92rem;">' + (d.className || '') + '</div>'
        + '<div style="font-size:.78rem;color:var(--gray);margin:.3rem 0;">ğŸ“± ' + (d.mode || '') + (d.phone ? ' Â· ' + d.phone : '') + ' Â· ' + date + '</div>'
        + startRow
        + (d.note ? '<div style="font-size:.78rem;background:var(--cream);border-radius:8px;padding:.4rem .7rem;margin:.3rem 0;">' + d.note + '</div>' : '')
        + (isPending
          ? '<button onclick="openConfirmEnrollModal(\'' + docId + '\',\'' + (d.studentName||'') + '\',\'' + (d.className||'') + '\',\'' + (d.classKey||'') + '\')" style="width:100%;margin-top:.6rem;background:linear-gradient(135deg,var(--sage),#5a9a60);color:white;border:none;border-radius:100px;padding:.55rem;font-size:.78rem;font-family:\'DM Sans\',sans-serif;cursor:pointer;">âœ“ ìˆ˜ê°• í™•ì •í•˜ê¸°</button>'
          : '')
        + '</div>';
    });
    listEl.innerHTML = html;
  } catch(err) {
    listEl.innerHTML = '<div style="color:var(--rose);font-size:.82rem;text-align:center;padding:1rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

// â”€â”€ ì½”ì¹˜: ìˆ˜ì—… ì‹œì‘ì¼ ìˆ˜ì • ëª¨ë‹¬ â”€â”€
function openEditStartDateModal(docId, currentDate) {
  var today = new Date().toISOString().split('T')[0];
  var val = (currentDate === 'ë¯¸ì§€ì •' ? today : currentDate);
  document.getElementById('modalTitle').textContent = 'ğŸ“… ìˆ˜ì—… ì‹œì‘ì¼ ìˆ˜ì •';
  document.getElementById('modalBody').innerHTML = `
    <div style="font-size:.78rem;color:var(--gray);margin-bottom:.8rem;">
      ì‹œì‘ì¼ì´ ë˜ë©´ í•™ìƒ í™”ë©´ì—ì„œ ìë™ìœ¼ë¡œ "ìˆ˜ê°• ì¤‘"ìœ¼ë¡œ ë°”ë€Œì–´ìš”
    </div>
    <input class="m-input" type="date" id="editStartDateInput" value="${val}">
    <button class="m-btn" id="editStartDateBtn" onclick="saveStartDate('${docId}')">ì €ì¥í•˜ê¸° â†’</button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

async function saveStartDate(docId) {
  var newDate = (document.getElementById('editStartDateInput')||{}).value;
  if (!newDate) { showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('editStartDateBtn');
  btn.textContent = 'ì €ì¥ ì¤‘...'; btn.disabled = true;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var today = new Date().toISOString().split('T')[0];
    // í˜„ì¬ statusë„ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°
    var docSnap = await mod.getDoc(mod.doc(window._db, 'enrollments', docId));
    var currentStatus = docSnap.exists() ? docSnap.data().status : 'confirmed';
    var newStatus = currentStatus;
    if (currentStatus === 'confirmed' || currentStatus === 'active') {
      newStatus = newDate <= today ? 'active' : 'confirmed';
    }
    await mod.updateDoc(mod.doc(window._db, 'enrollments', docId), {
      startDate: newDate,
      status: newStatus
    });
    closeModal();
    showToast('âœ… ì‹œì‘ì¼ì´ ' + newDate + 'ë¡œ ì €ì¥ëì–´ìš”!');
    loadCoachEnrollments();
  } catch(err) {
    showToast('ì €ì¥ ì‹¤íŒ¨'); 
    btn.textContent = 'ì €ì¥í•˜ê¸° â†’'; btn.disabled = false;
    console.error(err);
  }
}

// â”€â”€ ì½”ì¹˜: ìˆ˜ê°• í™•ì • ëª¨ë‹¬ (ì‹œì‘ì¼ ì…ë ¥) â”€â”€
function openConfirmEnrollModal(docId, studentName, className, classKey) {
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('modalTitle').textContent = 'âœ“ ìˆ˜ê°• í™•ì •';
  document.getElementById('modalBody').innerHTML = `
    <div style="background:var(--cream);border-radius:10px;padding:.7rem 1rem;margin-bottom:1rem;">
      <div style="font-size:.72rem;color:var(--gray);">í•™ìƒ</div>
      <div style="font-size:.95rem;font-weight:600;">${studentName}</div>
      <div style="font-size:.8rem;color:var(--gray);margin-top:.2rem;">${className}</div>
    </div>
    <div style="font-size:.78rem;color:var(--charcoal);margin-bottom:.4rem;font-weight:500;">ìˆ˜ì—… ì‹œì‘ì¼</div>
    <input class="m-input" type="date" id="enrollStartDate" value="${today}" min="${today}">
    <div style="font-size:.7rem;color:var(--gray);margin:-.3rem 0 .8rem .2rem;">
      ğŸ’¡ ì‹œì‘ì¼ì´ ë˜ë©´ í•™ìƒ í™”ë©´ì—ì„œ ìë™ìœ¼ë¡œ "ìˆ˜ê°• ì¤‘"ìœ¼ë¡œ ë°”ë€Œì–´ìš”
    </div>
    <button class="m-btn" id="confirmEnrollBtn" onclick="confirmEnroll('${docId}','${studentName}','${className}','${classKey}')">
      ìˆ˜ê°• í™•ì •í•˜ê¸° â†’
    </button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ì½”ì¹˜: ìˆ˜ê°• í™•ì • ì €ì¥ â”€â”€
async function confirmEnroll(docId, studentName, className, classKey) {
  var startDate = (document.getElementById('enrollStartDate')||{}).value;
  if (!startDate) { showToast('ì‹œì‘ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('confirmEnrollBtn');
  if (btn) { btn.textContent = 'í™•ì • ì¤‘...'; btn.disabled = true; }
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    // ì‹œì‘ì¼ì´ ì˜¤ëŠ˜ì´ë©´ ë°”ë¡œ active, ì•„ë‹ˆë©´ confirmed
    var today = new Date().toISOString().split('T')[0];
    var newStatus = startDate <= today ? 'active' : 'confirmed';
    await mod.updateDoc(mod.doc(window._db, 'enrollments', docId), {
      status: newStatus,
      startDate: startDate,
      confirmedAt: mod.serverTimestamp()
    });
    closeModal();
    showToast('âœ… ' + studentName + 'ë‹˜ ' + className + ' ìˆ˜ê°• í™•ì •! (ì‹œì‘ì¼: ' + startDate + ')');
    loadCoachEnrollments();
    loadCoachStudents();
  } catch(err) {
    showToast('í™•ì •ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
    if (btn) { btn.textContent = 'ìˆ˜ê°• í™•ì •í•˜ê¸° â†’'; btn.disabled = false; }
    console.error(err);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì±•í„° ê´€ë¦¬ (ì½”ì¹˜)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var _trackNames = { 'bible':'ì„±ê²½ì˜ì–´','speaking':'ì˜ì–´ íšŒí™”','writing':'ì˜ì–´ ê¸€ì“°ê¸°','coaching':'ì˜ì–´ ì½”ì¹­','kids':'í‚¤ì¦ˆ ì˜ì–´' };

// â”€â”€ ì±•í„° ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ â”€â”€
function openChapterModal(editId, editData) {
  var isEdit = !!editId;
  var d = editData || {};

  var trackOpts = Object.keys(_trackNames).map(function(k) {
    return '<option value="' + k + '"' + (d.track === k ? ' selected' : '') + '>' + _classEmoji[k] + ' ' + _trackNames[k] + '</option>';
  }).join('');

  // ë‹¨ì–´ ê¸°ë³¸ê°’ (5ê°œ)
  var cardsVal = d.cards ? d.cards.map(function(c) {
    return c.w + '|' + c.p + '|' + c.m + '|' + c.e;
  }).join('\n') : 'loved|[lÊŒvd]|ì‚¬ë‘í•˜ì…¨ë‹¤|"For God so loved the world"\nì˜ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”';

  // í€´ì¦ˆ ê¸°ë³¸ê°’
  var quizVal = d.quizzes ? d.quizzes.map(function(q) {
    return q.q + '|' + q.answer + '|' + q.opts.map(function(o){ return o.v + ':' + o.label; }).join(',') + '|' + q.ok + '|' + q.ng;
  }).join('\n') : '';

  document.getElementById('modalTitle').textContent = isEdit ? 'âœï¸ ì±•í„° ìˆ˜ì •' : 'ğŸ“– ìƒˆ ì±•í„° ë§Œë“¤ê¸°';
  document.getElementById('modalBody').innerHTML = `
    <div style="font-size:.72rem;color:var(--gray);background:var(--cream);border-radius:8px;padding:.6rem .8rem;margin-bottom:.8rem;line-height:1.6;">
      ğŸ’¡ ì…ë ¥í•œ ë‚´ìš©ì´ í•™ìƒ ì•± í•™ìŠµ í™”ë©´ì— ë°”ë¡œ ë°˜ì˜ë¼ìš”
    </div>

    <div style="font-size:.78rem;font-weight:600;margin-bottom:.3rem;">íŠ¸ë™ Â· ì±•í„°ë²ˆí˜¸</div>
    <div style="display:flex;gap:.5rem;margin-bottom:.7rem;">
      <select class="m-input" id="chTrack" style="flex:2;">${trackOpts}</select>
      <input class="m-input" id="chNum" type="number" placeholder="1" min="1" value="${d.chapterNum||''}" style="flex:1;">
    </div>

    <input class="m-input" id="chTitle" placeholder="ì±•í„° ì œëª© (ì˜ˆ: í•˜ë‚˜ë‹˜ì˜ ì‚¬ë‘)" value="${d.title||''}">
    <input class="m-input" id="chIcon" placeholder="ì•„ì´ì½˜ ì´ëª¨ì§€ (ì˜ˆ: âœï¸)" value="${d.icon||'âœï¸'}">
    <input class="m-input" id="chVerse" placeholder="ëŒ€í‘œ êµ¬ì ˆ (ì˜ˆ: John 3:16)" value="${d.ref||''}">
    <textarea class="m-input" id="chVerseEn" rows="3" placeholder="ì˜ì–´ êµ¬ì ˆ ì „ë¬¸ (HTML ê°€ëŠ¥, <b>ê°•ì¡°</b>)">${d.verseEn||''}</textarea>
    <textarea class="m-input" id="chVerseKo" rows="2" placeholder="í•œêµ­ì–´ ë²ˆì—­">${d.verseKo||''}</textarea>
    <input class="m-input" id="chVerseAudio" placeholder="TTS ë°œìŒìš© êµ¬ì ˆ (ì˜ì–´ ì›ë¬¸ ê·¸ëŒ€ë¡œ)" value="${d.verseAudio||''}">
    <input class="m-input" id="chSpeakText" placeholder="ë”°ë¼ë§í•˜ê¸° êµ¬ì ˆ (ì§§ê²Œ)" value="${d.speakText||''}">

    <div style="font-size:.78rem;font-weight:600;margin:.6rem 0 .3rem;">ğŸ“‡ ë‹¨ì–´ ì¹´ë“œ</div>
    <div style="font-size:.68rem;color:var(--gray);margin-bottom:.4rem;">í•œ ì¤„ì— ë‹¨ì–´ í•˜ë‚˜ Â· í˜•ì‹: ë‹¨ì–´|ë°œìŒ|ëœ»|ì˜ˆë¬¸</div>
    <textarea class="m-input" id="chCards" rows="6" placeholder="loved|[lÊŒvd]|ì‚¬ë‘í•˜ì…¨ë‹¤|ì˜ˆë¬¸...">${cardsVal}</textarea>

    <div style="font-size:.78rem;font-weight:600;margin:.6rem 0 .3rem;">â“ í€´ì¦ˆ (ì„ íƒ)</div>
    <div style="font-size:.68rem;color:var(--gray);margin-bottom:.4rem;">í˜•ì‹: ë¬¸ì œ|ì •ë‹µí‚¤|A:ë³´ê¸°,B:ë³´ê¸°,C:ë³´ê¸°,D:ë³´ê¸°|ì •ë‹µë©”ì‹œì§€|ì˜¤ë‹µë©”ì‹œì§€</div>
    <textarea class="m-input" id="chQuizzes" rows="5" placeholder='ì˜ˆ) "For God so ___ the world"|loved|A:likes,B:loved,C:made,D:saved|âœ“ ì •ë‹µ!|ë‹¤ì‹œ ë„ì „í•´ë´ìš”'>${quizVal}</textarea>

    <div style="font-size:.78rem;font-weight:600;margin:.6rem 0 .3rem;">ğŸ“ ë¬µìƒ ì¼ê¸° í”„ë¡¬í”„íŠ¸</div>
    <textarea class="m-input" id="chJournal" rows="2" placeholder="ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©ì— ëŒ€í•´ ì˜ì–´ë¡œ ì¨ë´ìš”.">${d.journalPrompt||''}</textarea>

    <button class="m-btn" id="chSaveBtn" onclick="saveChapter('${editId||''}')">
      ${isEdit ? 'ìˆ˜ì •í•˜ê¸° â†’' : 'ì±•í„° ì €ì¥í•˜ê¸° â†’'}
    </button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ì±•í„° ì €ì¥ â”€â”€
async function saveChapter(editId) {
  var title  = (document.getElementById('chTitle')||{}).value.trim();
  var track  = (document.getElementById('chTrack')||{}).value;
  var num    = parseInt((document.getElementById('chNum')||{}).value) || 1;
  var cardsRaw = (document.getElementById('chCards')||{}).value.trim();

  if (!title)    { showToast('ì±•í„° ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!cardsRaw) { showToast('ë‹¨ì–´ ì¹´ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  // ë‹¨ì–´ íŒŒì‹± (ë‹¨ì–´|ë°œìŒ|ëœ»|ì˜ˆë¬¸)
  var cards = cardsRaw.split('\n').filter(function(l){ return l.trim(); }).map(function(line) {
    var p = line.split('|');
    return { w: (p[0]||'').trim(), p: (p[1]||'').trim(), m: (p[2]||'').trim(), e: (p[3]||'').trim() };
  }).filter(function(c){ return c.w; });

  // í€´ì¦ˆ íŒŒì‹± (ë¬¸ì œ|ì •ë‹µ|A:ë³´ê¸°,...|ì •ë‹µë©”ì‹œì§€|ì˜¤ë‹µë©”ì‹œì§€)
  var quizRaw = (document.getElementById('chQuizzes')||{}).value.trim();
  var quizzes = quizRaw ? quizRaw.split('\n').filter(function(l){ return l.trim(); }).map(function(line) {
    var p = line.split('|');
    var opts = (p[2]||'').split(',').map(function(o, i) {
      var kv = o.split(':');
      return { v: (kv[0]||String.fromCharCode(65+i)).trim(), label: (kv[1]||o).trim() };
    });
    return { type:'í€´ì¦ˆ', q:(p[0]||'').trim(), answer:(p[1]||'').trim(), opts:opts, ok:(p[3]||'âœ“ ì •ë‹µ!').trim(), ng:(p[4]||'ë‹¤ì‹œ ë„ì „í•´ë´ìš”').trim() };
  }).filter(function(q){ return q.q; }) : [];

  // ë‹¨ì–´ ëª©ë¡ (ë“£ê¸° í™”ë©´ìš©)
  var wordList = cards.map(function(c) {
    return { w: c.w, m: c.m + ' ' + c.p };
  });

  var chapterId = track + '-' + String(num).padStart(2,'0');
  var data = {
    id: chapterId,
    track: track,
    trackName: _trackNames[track] || track,
    chapterNum: num,
    chapter: 'Ch.' + num,
    title: title,
    icon: (document.getElementById('chIcon')||{}).value.trim() || 'ğŸ“–',
    ref: (document.getElementById('chVerse')||{}).value.trim(),
    verse: '"' + (document.getElementById('chSpeakText')||{}).value.trim() + '..."',
    desc: _trackNames[track] + ' Â· ì•½ 20ë¶„',
    doneMsg: title + '\nì˜ í•˜ì…¨ì–´ìš”! ğŸ’•',
    verseEn: (document.getElementById('chVerseEn')||{}).value.trim(),
    verseKo: (document.getElementById('chVerseKo')||{}).value.trim(),
    verseAudio: (document.getElementById('chVerseAudio')||{}).value.trim(),
    speakText: (document.getElementById('chSpeakText')||{}).value.trim(),
    dictHint: 'íŒíŠ¸: "' + (cards[0]||{}).w + '..."',
    dictAnswer: (document.getElementById('chVerseAudio')||{}).value.trim(),
    cards: cards,
    wordList: wordList,
    phrases: cards.slice(0,4).map(function(c){ return c.w; }),
    quizzes: quizzes,
    journalPrompt: (document.getElementById('chJournal')||{}).value.trim() || 'ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©ì— ëŒ€í•´ ì˜ì–´ë¡œ ì¨ë´ìš”.',
    journalChips: [
      { label:'Today I learned...', text:'Today I learned ' },
      { label:'I am grateful...', text:'I am grateful because ' }
    ],
    nextChapter: null,
    published: true,
    updatedAt: null
  };

  var btn = document.getElementById('chSaveBtn');
  btn.textContent = 'ì €ì¥ ì¤‘...'; btn.disabled = true;

  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    data.updatedAt = mod.serverTimestamp();
    if (editId) {
      await mod.updateDoc(mod.doc(window._db, 'chapters', editId), data);
      showToast('âœ… ì±•í„°ë¥¼ ìˆ˜ì •í–ˆì–´ìš”!');
    } else {
      data.createdAt = mod.serverTimestamp();
      data.createdBy = window._currentUser.uid;
      await mod.setDoc(mod.doc(window._db, 'chapters', chapterId), data);
      showToast('âœ… ì±•í„°ë¥¼ ì €ì¥í–ˆì–´ìš”! í•™ìƒ ì•±ì— ë°”ë¡œ ë°˜ì˜ëì–´ìš” ğŸ‰');
    }
    closeModal();
    loadCoachChapters();
  } catch(err) {
    showToast('ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    btn.textContent = 'ì±•í„° ì €ì¥í•˜ê¸° â†’'; btn.disabled = false;
    console.error(err);
  }
}

// â”€â”€ ì½”ì¹˜: ì±•í„° ëª©ë¡ ë¡œë“œ â”€â”€
async function loadCoachChapters() {
  var listEl = document.getElementById('coach-chapter-list');
  if (!listEl) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'chapters'),
      mod.orderBy('track'), mod.orderBy('chapterNum')
    ));
    if (snap.empty) {
      listEl.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--gray);font-size:.82rem;">ì•„ì§ ë§Œë“  ì±•í„°ê°€ ì—†ì–´ìš”<br><span style="font-size:.72rem;">ìœ„ ë²„íŠ¼ìœ¼ë¡œ ì²« ì±•í„°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš” ğŸ“–</span></div>';
      return;
    }
    var html = '';
    snap.forEach(function(ds) {
      var d = ds.data();
      html += '<div style="display:flex;align-items:center;gap:.6rem;padding:.6rem .5rem;border-bottom:1px solid var(--light);">'
        + '<span style="font-size:1rem;">' + (d.icon||'ğŸ“–') + '</span>'
        + '<div style="flex:1;min-width:0;">'
        + '<div style="font-size:.83rem;font-weight:500;">' + d.chapter + ' ' + d.title + '</div>'
        + '<div style="font-size:.65rem;color:var(--gray);">' + (_classEmoji[d.track]||'') + ' ' + (d.trackName||d.track) + ' Â· ë‹¨ì–´ ' + (d.cards||[]).length + 'ê°œ Â· í€´ì¦ˆ ' + (d.quizzes||[]).length + 'ê°œ</div>'
        + '</div>'
        + '<button onclick="openChapterModal(\'' + ds.id + '\',' + JSON.stringify(d).replace(/'/g,'&apos;') + ')" style="font-size:.68rem;background:none;border:1px solid var(--light);border-radius:20px;padding:.2rem .5rem;cursor:pointer;color:var(--gray);">ìˆ˜ì •</button>'
        + '<button onclick="deleteChapter(\'' + ds.id + '\')" style="font-size:.68rem;background:none;border:1px solid var(--rose-light);border-radius:20px;padding:.2rem .5rem;cursor:pointer;color:var(--rose);">ì‚­ì œ</button>'
        + '</div>';
    });
    listEl.innerHTML = html;
  } catch(err) { console.error(err); }
}

// â”€â”€ ì±•í„° ì‚­ì œ â”€â”€
async function deleteChapter(docId) {
  if (!confirm('ì´ ì±•í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.deleteDoc(mod.doc(window._db, 'chapters', docId));
    showToast('ì‚­ì œëì–´ìš”');
    loadCoachChapters();
  } catch(err) { showToast('ì‚­ì œ ì‹¤íŒ¨'); console.error(err); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í•™ìŠµ ìë£Œ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var _classNames = {
  'bible':'ì„±ê²½ì˜ì–´ ì†Œê·¸ë£¹','speaking':'ì˜ì–´ íšŒí™” 1:1',
  'writing':'ì˜ì–´ ê¸€ì“°ê¸° ê³¼ì •','coaching':'ì˜ì–´ ì½”ì¹­','kids':'í‚¤ì¦ˆ ì˜ì–´'
};
var _classEmoji = { 'bible':'ğŸ“–','speaking':'ğŸ’¬','writing':'âœï¸','coaching':'ğŸŒ±','kids':'ğŸŒ¿' };
var _linkIcon = function(url) {
  if (!url) return 'ğŸ”—';
  if (url.includes('youtube') || url.includes('youtu.be')) return 'â–¶ï¸';
  if (url.includes('drive.google') || url.includes('docs.google')) return 'ğŸ“„';
  if (url.includes('notion')) return 'ğŸ“';
  return 'ğŸ”—';
};

// â”€â”€ ì½”ì¹˜: ìë£Œ ì¶”ê°€ ëª¨ë‹¬ â”€â”€
async function openAddMaterialModal(editId, editData) {
  var isEdit = !!editId;

  // í•™ìƒ ëª©ë¡ ë¡œë“œ
  var studentOpts = '<option value="all">ğŸ“¢ ì „ì²´ (ìˆ˜ì—… ê³µí†µ)</option>';
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var uSnap = await mod.getDocs(mod.query(mod.collection(window._db,'users'), mod.where('role','==','student')));
    uSnap.forEach(function(ds) {
      var d = ds.data();
      studentOpts += '<option value="' + ds.id + '"' + (editData && editData.targetUid === ds.id ? ' selected' : '') + '>' + (d.name||'') + ' (' + (d.email||'') + ')</option>';
    });
  } catch(e) {}

  var classOpts = ['bible','speaking','writing','coaching','kids'].map(function(k) {
    var sel = editData && editData.classKey === k ? ' selected' : '';
    return '<option value="' + k + '"' + sel + '>' + _classEmoji[k] + ' ' + _classNames[k] + '</option>';
  }).join('');

  document.getElementById('modalTitle').textContent = isEdit ? 'âœï¸ ìë£Œ ìˆ˜ì •' : 'ğŸ“ ìë£Œ ë§í¬ ì¶”ê°€';
  document.getElementById('modalBody').innerHTML = `
    <select class="m-input" id="matClass">${classOpts}</select>
    <select class="m-input" id="matTarget">${studentOpts}</select>
    <input class="m-input" id="matTitle" placeholder="ìë£Œ ì œëª© (ì˜ˆ: John 3ì¥ ì˜ì–´ ë³¸ë¬¸)" value="${editData ? editData.title : ''}">
    <input class="m-input" id="matUrl" type="url" placeholder="ë§í¬ URL (Google Drive, YouTube, Notion ë“±)" value="${editData ? editData.url : ''}">
    <div style="font-size:.72rem;color:var(--gray);margin:-0.3rem 0 .8rem .2rem;">ğŸ’¡ Google DriveëŠ” ê³µìœ  ë§í¬ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”</div>
    <button class="m-btn" id="matSaveBtn" onclick="saveMaterial('${editId||''}')">
      ${isEdit ? 'ìˆ˜ì •í•˜ê¸° â†’' : 'ì¶”ê°€í•˜ê¸° â†’'}
    </button>`;
  document.getElementById('modalOverlay').classList.add('open');
}

// â”€â”€ ì½”ì¹˜: ìë£Œ ì €ì¥ (ì¶”ê°€/ìˆ˜ì •) â”€â”€
async function saveMaterial(editId) {
  var title  = (document.getElementById('matTitle')||{}).value.trim();
  var url    = (document.getElementById('matUrl')||{}).value.trim();
  var cls    = (document.getElementById('matClass')||{}).value;
  var target = (document.getElementById('matTarget')||{}).value;
  if (!title) { showToast('ìë£Œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  if (!url)   { showToast('ë§í¬ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  var btn = document.getElementById('matSaveBtn');
  btn.textContent = 'ì €ì¥ ì¤‘...'; btn.disabled = true;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var data = {
      classKey: cls,
      className: _classNames[cls] || cls,
      targetUid: target === 'all' ? null : target,  // null = ì „ì²´
      title: title,
      url: url,
      updatedAt: mod.serverTimestamp()
    };
    if (editId) {
      await mod.updateDoc(mod.doc(window._db, 'materials', editId), data);
      showToast('âœ… ìë£Œë¥¼ ìˆ˜ì •í–ˆì–´ìš”!');
    } else {
      data.createdAt = mod.serverTimestamp();
      data.createdBy = window._currentUser.uid;
      await mod.addDoc(mod.collection(window._db, 'materials'), data);
      showToast('âœ… ìë£Œë¥¼ ì¶”ê°€í–ˆì–´ìš”!');
    }
    closeModal();
    loadCoachMaterials();
  } catch(err) {
    showToast('ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    btn.textContent = 'ì¶”ê°€í•˜ê¸° â†’'; btn.disabled = false;
    console.error(err);
  }
}

// â”€â”€ ì½”ì¹˜: ìë£Œ ëª©ë¡ ë¡œë“œ â”€â”€
async function loadCoachMaterials() {
  var listEl = document.getElementById('coach-materials-list');
  if (!listEl) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.collection(window._db, 'materials'));
    if (snap.empty) {
      listEl.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--gray);font-size:.82rem;">ì•„ì§ ì¶”ê°€ëœ ìë£Œê°€ ì—†ì–´ìš”</div>';
      return;
    }
    // ìˆ˜ì—…ë³„ë¡œ ê·¸ë£¹í•‘
    var grouped = {};
    snap.forEach(function(ds) {
      var d = ds.data(); var k = d.classKey || 'etc';
      if (!grouped[k]) grouped[k] = [];
      grouped[k].push({ id: ds.id, data: d });
    });

    var html = '';
    Object.keys(grouped).forEach(function(cls) {
      html += '<div style="margin-bottom:.8rem;">'
        + '<div style="font-size:.75rem;font-weight:600;color:var(--gray);margin-bottom:.4rem;">'
        + (_classEmoji[cls]||'ğŸ“š') + ' ' + (_classNames[cls]||cls) + '</div>';
      grouped[cls].forEach(function(item) {
        var d = item.data;
        var icon = _linkIcon(d.url);
        var targetLabel = d.targetUid ? 'ğŸ‘¤ ê°œì¸' : 'ğŸ‘¥ ì „ì²´';
        html += '<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem .6rem;background:var(--warm);border-radius:10px;margin-bottom:.35rem;">'
          + '<span style="font-size:.9rem;">' + icon + '</span>'
          + '<div style="flex:1;min-width:0;">'
          + '<div style="font-size:.82rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + d.title + '</div>'
          + '<div style="font-size:.65rem;color:var(--gray);">' + targetLabel + '</div>'
          + '</div>'
          + '<button onclick="openAddMaterialModal(\'' + item.id + '\',' + JSON.stringify(d).replace(/'/g,'&apos;') + ')" style="font-size:.7rem;background:none;border:1px solid var(--light);border-radius:20px;padding:.2rem .55rem;cursor:pointer;color:var(--gray);">ìˆ˜ì •</button>'
          + '<button onclick="deleteMaterial(\'' + item.id + '\')" style="font-size:.7rem;background:none;border:1px solid var(--rose-light);border-radius:20px;padding:.2rem .55rem;cursor:pointer;color:var(--rose);">ì‚­ì œ</button>'
          + '</div>';
      });
      html += '</div>';
    });
    listEl.innerHTML = html;
  } catch(err) { console.error(err); }
}

// â”€â”€ ì½”ì¹˜: ìë£Œ ì‚­ì œ â”€â”€
async function deleteMaterial(docId) {
  if (!confirm('ì´ ìë£Œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.deleteDoc(mod.doc(window._db, 'materials', docId));
    showToast('ì‚­ì œëì–´ìš”');
    loadCoachMaterials();
  } catch(err) { showToast('ì‚­ì œ ì‹¤íŒ¨'); console.error(err); }
}

// â”€â”€ í•™ìƒ: ìˆ˜ì—… ìë£Œ ë³´ê¸° ëª¨ë‹¬ (Firebase ì—°ë™) â”€â”€
async function openClassMaterials(classKey, className) {
  document.getElementById('modalTitle').textContent = (_classEmoji[classKey]||'ğŸ“š') + ' ' + className + ' ìë£Œ';
  document.getElementById('modalBody').innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  document.getElementById('modalOverlay').classList.add('open');

  try {
    var user = window._currentUser;
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');

    // ì „ì²´ ê³µí†µ ìë£Œ + ë‚˜ì—ê²Œ ì§€ì •ëœ ìë£Œ
    var [snapAll, snapMe] = await Promise.all([
      mod.getDocs(mod.query(mod.collection(window._db,'materials'),
        mod.where('classKey','==',classKey), mod.where('targetUid','==',null))),
      mod.getDocs(mod.query(mod.collection(window._db,'materials'),
        mod.where('classKey','==',classKey), mod.where('targetUid','==',user.uid)))
    ]);

    var items = [];
    snapAll.forEach(function(ds) { items.push(ds.data()); });
    snapMe.forEach(function(ds) { items.push(Object.assign({}, ds.data(), { personal: true })); });

    if (items.length === 0) {
      document.getElementById('modalBody').innerHTML = `
        <div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">
          ì•„ì§ ë“±ë¡ëœ ìë£Œê°€ ì—†ì–´ìš” ğŸ“­<br>
          <span style="font-size:.75rem;">ì½”ì¹˜ë‹˜ì´ ê³§ ì—…ë¡œë“œí•´ë“œë¦´ê²Œìš”!</span>
        </div>`;
      return;
    }

    var html = '<div style="background:var(--cream);border-radius:10px;padding:.5rem .9rem;margin-bottom:.8rem;font-size:.72rem;color:var(--gray);">ìˆ˜ì—… ìë£Œë¥¼ ëˆŒëŸ¬ ë°”ë¡œ ì—´ì–´ë³´ì„¸ìš” ğŸ”—</div>';
    items.forEach(function(d) {
      var icon = _linkIcon(d.url);
      var personalBadge = d.personal
        ? '<span style="font-size:.6rem;background:var(--rose-light);color:var(--rose);border-radius:20px;padding:.1rem .4rem;margin-left:.3rem;">ê°œì¸</span>'
        : '';
      html += '<a href="' + d.url + '" target="_blank" rel="noopener" style="text-decoration:none;">'
        + '<div style="display:flex;align-items:center;gap:.7rem;padding:.7rem .4rem;border-bottom:1px solid var(--light);">'
        + '<span style="font-size:1.1rem;">' + icon + '</span>'
        + '<div style="flex:1;">'
        + '<div style="font-size:.84rem;color:var(--charcoal);font-weight:500;">' + d.title + personalBadge + '</div>'
        + '<div style="font-size:.65rem;color:var(--gray);margin-top:.1rem;">' + (d.url.length > 40 ? d.url.substring(0,40) + '...' : d.url) + '</div>'
        + '</div>'
        + '<span style="font-size:.8rem;color:var(--rose);">ì—´ê¸° â€º</span>'
        + '</div></a>';
    });
    document.getElementById('modalBody').innerHTML = html;
  } catch(err) {
    document.getElementById('modalBody').innerHTML = '<div style="color:var(--rose);text-align:center;padding:1rem;font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

// â”€â”€ ì½”ì¹˜: íŒ¨í‚¤ì§€ ì‹ ì²­ ëª©ë¡ â”€â”€
async function loadCoachPackageRequests() {
  var listEl = document.getElementById('coach-package-list');
  if (!listEl) return;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'packageRequests'),
      mod.orderBy('requestedAt', 'desc')
    ));
    if (snap.empty) {
      listEl.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--gray);font-size:.82rem;">ì•„ì§ ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</div>';
      return;
    }
    var html = '';
    snap.forEach(function(ds) {
      var d = ds.data();
      var date = d.requestedAt ? new Date(d.requestedAt.seconds * 1000).toLocaleDateString('ko-KR') : 'ë°©ê¸ˆ';
      var isNew = d.status === 'pending';
      var loginBadge = d.isLoggedIn
        ? '<span style="font-size:.6rem;background:var(--sage-light);color:var(--sage);border-radius:20px;padding:.1rem .45rem;margin-left:.3rem;">ì•±íšŒì›</span>'
        : '<span style="font-size:.6rem;background:var(--gold-light);color:#8a6a30;border-radius:20px;padding:.1rem .45rem;margin-left:.3rem;">í™ˆí˜ì´ì§€</span>';

      html += '<div class="hw-card" style="margin-bottom:.8rem;">'
        + '<div class="hw-top">'
        + '<div class="hw-class">ğŸ“¦ ' + (d.packageName || 'íŒ¨í‚¤ì§€') + '</div>'
        + '<span class="hw-status ' + (isNew ? 'pending' : 'done') + '">' + (isNew ? 'â³ ì‹ ê·œ' : 'âœ“ í™•ì¸') + '</span>'
        + '</div>'
        + '<div style="font-size:.92rem;font-weight:600;margin:.2rem 0;">'
        + d.name + loginBadge
        + '</div>'
        + '<div style="font-size:.78rem;color:var(--gray);margin:.2rem 0;">'
        + 'ğŸ“± ' + d.phone + ' Â· âœ‰ï¸ ' + d.email
        + '</div>'
        + '<div style="font-size:.75rem;color:var(--gray);margin:.2rem 0;">'
        + d.mode + ' Â· ' + d.time + ' Â· ' + d.level
        + '</div>'
        + (d.note ? '<div style="font-size:.78rem;background:var(--cream);border-radius:8px;padding:.4rem .7rem;margin:.4rem 0;">' + d.note + '</div>' : '')
        + '<div style="font-size:.7rem;color:var(--gray);margin-top:.3rem;">' + d.packagePrice + ' Â· ' + date + '</div>'
        + (isNew ? '<button onclick="markPackageChecked(\'' + ds.id + '\')" style="width:100%;margin-top:.6rem;background:var(--charcoal);color:var(--cream);border:none;border-radius:100px;padding:.5rem;font-size:.76rem;font-family:\'DM Sans\',sans-serif;cursor:pointer;">âœ“ í™•ì¸ ì™„ë£Œ</button>' : '')
        + '</div>';
    });
    listEl.innerHTML = html;
  } catch(err) {
    listEl.innerHTML = '<div style="color:var(--rose);font-size:.82rem;text-align:center;padding:1rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

async function markPackageChecked(docId) {
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.updateDoc(mod.doc(window._db, 'packageRequests', docId), { status: 'checked' });
    showToast('âœ… í™•ì¸ ì™„ë£Œ!');
    loadCoachPackageRequests();
  } catch(err) { showToast('ì‹¤íŒ¨í–ˆì–´ìš”'); console.error(err); }
}

// â”€â”€ í•™ìƒ: ì±•í„° ëª©ë¡ ëª¨ë‹¬ â”€â”€
async function openChapterListModal() {
  document.getElementById('modalTitle').textContent = 'ğŸ“– í•™ìŠµ ì±•í„°';
  document.getElementById('modalBody').innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  document.getElementById('modalOverlay').classList.add('open');

  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var snap = await mod.getDocs(mod.query(
      mod.collection(window._db, 'chapters'),
      mod.where('published', '==', true),
      mod.orderBy('track'), mod.orderBy('chapterNum')
    ));

    if (snap.empty) {
      document.getElementById('modalBody').innerHTML = `
        <div style="text-align:center;padding:2rem;color:var(--gray);font-size:.85rem;">
          ğŸ“­ ì•„ì§ ì—…ë¡œë“œëœ ì±•í„°ê°€ ì—†ì–´ìš”<br>
          <span style="font-size:.75rem;">ì½”ì¹˜ë‹˜ì´ ê³§ ì—…ë¡œë“œí•´ì£¼ì‹¤ ê±°ì˜ˆìš”!</span>
        </div>`;
      return;
    }

    // íŠ¸ë™ë³„ ê·¸ë£¹í•‘
    var grouped = {};
    snap.forEach(function(ds) {
      var d = ds.data();
      var k = d.track || 'etc';
      if (!grouped[k]) grouped[k] = [];
      grouped[k].push({ id: ds.id, data: d });
    });

    var html = '<div style="font-size:.72rem;color:var(--gray);background:var(--cream);border-radius:8px;padding:.5rem .8rem;margin-bottom:.8rem;">ì±•í„°ë¥¼ íƒ­í•˜ë©´ ë°”ë¡œ í•™ìŠµì´ ì‹œì‘ë¼ìš” ğŸ¯</div>';

    Object.keys(grouped).forEach(function(track) {
      html += '<div style="margin-bottom:1rem;">'
        + '<div style="font-size:.75rem;font-weight:600;color:var(--gray);margin-bottom:.4rem;">'
        + (_classEmoji[track]||'ğŸ“š') + ' ' + (_trackNames[track]||track)
        + '</div>';

      grouped[track].forEach(function(item) {
        var d = item.data;
        html += '<div onclick="startChapter(\'' + item.id + '\')" style="display:flex;align-items:center;gap:.7rem;padding:.7rem .5rem;border-radius:12px;border:1.5px solid var(--light);margin-bottom:.4rem;cursor:pointer;background:var(--warm);">'
          + '<span style="font-size:1.3rem;">' + (d.icon||'ğŸ“–') + '</span>'
          + '<div style="flex:1;">'
          + '<div style="font-size:.85rem;font-weight:600;">' + d.chapter + ' ' + d.title + '</div>'
          + '<div style="font-size:.68rem;color:var(--gray);margin-top:.1rem;">'
          + 'ë‹¨ì–´ ' + (d.cards||[]).length + 'ê°œ Â· í€´ì¦ˆ ' + (d.quizzes||[]).length + 'ê°œ Â· ì•½ 20ë¶„'
          + '</div>'
          + '</div>'
          + '<span style="font-size:.85rem;color:var(--rose);">â†’</span>'
          + '</div>';
      });
      html += '</div>';
    });

    document.getElementById('modalBody').innerHTML = html;
  } catch(err) {
    document.getElementById('modalBody').innerHTML = '<div style="color:var(--rose);text-align:center;padding:1rem;font-size:.82rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

function startChapter(chapterId) {
  closeModal();
  window.location.href = 'ivyel-learn.html?ch=' + chapterId;
}

// â”€â”€ API í‚¤ ê´€ë¦¬ â”€â”€
function manageApiKey() {
  var existing = localStorage.getItem('ivyel_anthropic_key');
  var msg = existing
    ? 'API í‚¤ê°€ ì €ì¥ë˜ì–´ ìˆì–´ìš”.\në³€ê²½í•˜ë ¤ë©´ ìƒˆ í‚¤ë¥¼ ì…ë ¥í•˜ê³ , ì‚­ì œí•˜ë ¤ë©´ ì·¨ì†Œ í›„ ì‚­ì œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.\n\nìƒˆ API í‚¤ (ë³€ê²½ ì‹œ ì…ë ¥):'
    : 'Anthropic API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(https://console.anthropic.com ì—ì„œ ë°œê¸‰)\n\nAPI í‚¤:';
  var newKey = prompt(msg, existing ? '****ê¸°ì¡´í‚¤ìœ ì§€****' : '');
  if (newKey === null) return; // ì·¨ì†Œ
  if (newKey === '****ê¸°ì¡´í‚¤ìœ ì§€****') return; // ë³€ê²½ ì•ˆ í•¨
  if (!newKey.trim()) {
    // ë¹ˆ ê°’ ì…ë ¥ â†’ ì‚­ì œ
    localStorage.removeItem('ivyel_anthropic_key');
    updateApiKeyStatus();
    showToast('API í‚¤ê°€ ì‚­ì œëì–´ìš”');
    return;
  }
  localStorage.setItem('ivyel_anthropic_key', newKey.trim());
  updateApiKeyStatus();
  showToast('âœ… API í‚¤ê°€ ì €ì¥ëì–´ìš”!');
}

function updateApiKeyStatus() {
  var btn = document.getElementById('apiKeyStatusBtn');
  if (!btn) return;
  var key = localStorage.getItem('ivyel_anthropic_key') || '';
  if (key) {
    var masked = key.substring(0, 14) + 'â€¢â€¢â€¢â€¢' + key.slice(-4);
    btn.textContent = 'ğŸ”‘ ë“±ë¡ë¨: ' + masked + '  Â· ë³€ê²½';
    btn.style.borderColor = 'var(--sage)';
    btn.style.color = 'var(--sage)';
  } else {
    btn.textContent = 'ğŸ”‘ API í‚¤ ë“±ë¡í•˜ê¸° (AI í”¼ë“œë°± ì‚¬ìš© í•„ìš”)';
    btn.style.borderColor = 'var(--rose)';
    btn.style.color = 'var(--rose)';
  }
}

// â”€â”€ ì½”ì¹˜: ì „ì²´ ì œì¶œ ëª©ë¡ ë¡œë“œ â”€â”€
async function loadCoachSubmissions() {
  var listEl = document.getElementById('coach-hw-list');
  if (!listEl) return;
  listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var q = mod.query(mod.collection(window._db, 'homework'));
    var snap = await mod.getDocs(q);
    if (snap.empty) {
      listEl.innerHTML = '<div style="text-align:center;padding:1.5rem;color:var(--gray);font-size:.85rem;">ì•„ì§ ì œì¶œëœ ê³¼ì œê°€ ì—†ì–´ìš”</div>';
      return;
    }
    // ìµœì‹ ìˆœ ì •ë ¬
    var docs = [];
    snap.forEach(function(ds) { docs.push({ id: ds.id, data: ds.data() }); });
    docs.sort(function(a, b) {
      var ta = a.data.submittedAt ? a.data.submittedAt.seconds : 0;
      var tb = b.data.submittedAt ? b.data.submittedAt.seconds : 0;
      return tb - ta;
    });

    var html = ''; var unreviewed = 0;
    docs.forEach(function(item) {
      var d = item.data; var docId = item.id;
      if (!d.feedback) unreviewed++;
      var date = d.submittedAt ? new Date(d.submittedAt.seconds * 1000).toLocaleDateString('ko-KR') : 'ë°©ê¸ˆ';

      var actionBtns = '';
      if (!d.feedback) {
        actionBtns = '<div style="display:flex;gap:.5rem;margin-top:.7rem;">'
          + '<button onclick="openAiFeedbackModal(\'' + docId + '\',\'' + (d.studentName||'') + '\',`' + (d.text||'').replace(/`/g,"'") + '`,\'' + (d.hwTitle||'') + '\')" '
          + 'style="flex:1;background:linear-gradient(135deg,var(--rose),var(--gold));color:white;border:none;border-radius:100px;padding:.5rem;font-size:.75rem;font-family:\'DM Sans\',sans-serif;cursor:pointer;">âœ¨ AI í”¼ë“œë°± ë³´ë‚´ê¸°</button>'
          + '<button onclick="openManualFeedbackModal(\'' + docId + '\',\'' + (d.studentName||'') + '\')" '
          + 'style="flex:1;background:none;border:1.5px solid var(--light);border-radius:100px;padding:.5rem;font-size:.75rem;font-family:\'DM Sans\',sans-serif;cursor:pointer;color:var(--charcoal);">âœï¸ ì§ì ‘ ì‘ì„±</button>'
          + '</div>';
      } else {
        actionBtns = '<div style="background:var(--sage-light);border-radius:10px;padding:.6rem 1rem;margin-top:.6rem;font-size:.78rem;color:#3a6b3e;">ğŸ’Œ í•™ìƒ í”¼ë“œë°±: ' + d.feedback + '</div>'
          + (d.coachNote ? '<div style="background:linear-gradient(135deg,var(--cream),var(--rose-light));border:1px solid var(--rose-light);border-radius:10px;padding:.6rem 1rem;margin-top:.4rem;font-size:.75rem;color:#8a4a3e;">ğŸ”’ ì½”ì¹˜ ë…¸íŠ¸: ' + d.coachNote + '</div>' : '');
      }

      html += '<div class="hw-card">'
        + '<div class="hw-top">'
        + '<div class="hw-class">ğŸ“ ' + (d.studentName||'í•™ìƒ') + '</div>'
        + '<span class="hw-status ' + (d.feedback ? 'done' : 'pending') + '">' + (d.feedback ? 'âœ“ ì™„ë£Œ' : 'ë¯¸í™•ì¸') + '</span>'
        + '</div>'
        + '<div class="hw-title" style="font-size:.95rem;">' + (d.hwTitle||'') + '</div>'
        + (d.text ? '<div style="font-size:.82rem;line-height:1.6;margin:.4rem 0;color:var(--gray);">' + d.text + '</div>' : '')
        + '<div style="font-size:.7rem;color:var(--gray);">ì œì¶œì¼: ' + date + '</div>'
        + actionBtns
        + '</div>';
    });
    listEl.innerHTML = html;

    // ë¯¸í™•ì¸ ë°°ì§€ ì—…ë°ì´íŠ¸
    var statEls = document.querySelectorAll('.cs-num');
    if (statEls[2]) statEls[2].textContent = unreviewed;
  } catch(err) {
    listEl.innerHTML = '<div style="color:var(--rose);font-size:.82rem;text-align:center;padding:1rem;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    console.error(err);
  }
}

// â”€â”€ AI í”¼ë“œë°± ëª¨ë‹¬ â”€â”€
function openAiFeedbackModal(docId, studentName, hwText, hwTitle) {
  const overlay = document.getElementById('modalOverlay');
  document.getElementById('modalTitle').textContent = 'âœ¨ AI í”¼ë“œë°± ìƒì„±';
  document.getElementById('modalBody').innerHTML = `
    <div style="background:var(--cream);border-radius:12px;padding:.8rem 1rem;margin-bottom:1rem;font-size:.82rem;line-height:1.6;">
      <div style="font-size:.7rem;color:var(--rose);margin-bottom:.3rem;">ğŸ“ ${studentName}ë‹˜ì˜ ì œì¶œ ë‚´ìš©</div>
      <div style="color:var(--charcoal);">${hwText || '(ë‚´ìš© ì—†ìŒ)'}</div>
    </div>

    <div id="aiFeedbackResult" style="display:none;margin-bottom:1rem;">
      <!-- í•™ìƒ ì „ì†¡ìš© -->
      <div style="font-size:.7rem;font-weight:600;color:var(--sage);letter-spacing:.06em;text-transform:uppercase;margin-bottom:.4rem;">ğŸ“¨ í•™ìƒì—ê²Œ ì „ì†¡ë˜ëŠ” ë‚´ìš©</div>
      <div id="feedbackForStudent" style="background:linear-gradient(135deg,var(--cream),#f0f7f0);border:1.5px solid var(--sage-light);border-radius:12px;padding:1rem;font-size:.83rem;line-height:1.8;color:var(--charcoal);white-space:pre-wrap;margin-bottom:.8rem;"></div>
      <!-- ì½”ì¹˜ ì „ìš© -->
      <div style="font-size:.7rem;font-weight:600;color:var(--rose);letter-spacing:.06em;text-transform:uppercase;margin-bottom:.4rem;">ğŸ”’ ì½”ì¹˜ë‹˜ë§Œ ë³´ì´ëŠ” ë‚´ìš©</div>
      <div id="feedbackForCoach" style="background:linear-gradient(135deg,var(--cream),var(--rose-light));border:1.5px solid var(--rose-light);border-radius:12px;padding:1rem;font-size:.83rem;line-height:1.8;color:var(--charcoal);white-space:pre-wrap;"></div>
    </div>

    <div id="aiFeedbackError" style="display:none;background:#fff0f0;border:1.5px solid var(--rose-light);border-radius:12px;padding:.8rem 1rem;margin-bottom:.8rem;font-size:.78rem;color:var(--rose);white-space:pre-wrap;word-break:break-all;"></div>
    <button class="m-btn" id="aiGenerateBtn" onclick="generateAiFeedback('${docId}','${studentName}',\`${hwText.replace(/`/g,"'")}\`,'${hwTitle}')">
      âœ¨ AI í”¼ë“œë°± ìƒì„±í•˜ê¸°
    </button>
    <button id="aiSendBtn" style="display:none;width:100%;margin-top:.6rem;background:var(--sage);color:white;border:none;border-radius:100px;padding:.9rem;font-size:.88rem;font-family:'DM Sans',sans-serif;cursor:pointer;" onclick="sendAiFeedback('${docId}','${studentName}')">
      ğŸ’Œ í•™ìƒì—ê²Œ ì „ì†¡í•˜ê¸°
    </button>`;
  overlay.classList.add('open');
}

// â”€â”€ Claude APIë¡œ AI í”¼ë“œë°± ìƒì„± â”€â”€
async function generateAiFeedback(docId, studentName, hwText, hwTitle) {
  var btn = document.getElementById('aiGenerateBtn');
  var resultEl = document.getElementById('aiFeedbackResult');
  var errorEl = document.getElementById('aiFeedbackError');

  if (errorEl) errorEl.style.display = 'none';

  // API í‚¤ í™•ì¸
  var apiKey = localStorage.getItem('ivyel_anthropic_key') || '';
  if (!apiKey) {
    var inputKey = prompt('Anthropic API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\n(https://console.anthropic.com â†’ API Keys â†’ Create Key\nsk-ant-... ë¡œ ì‹œì‘í•˜ëŠ” í‚¤)');
    if (!inputKey || !inputKey.trim()) { showToast('API í‚¤ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”'); return; }
    apiKey = inputKey.trim();
    localStorage.setItem('ivyel_anthropic_key', apiKey);
    updateApiKeyStatus();
  }

  btn.textContent = 'ìƒì„± ì¤‘...âœ¨'; btn.disabled = true;
  resultEl.style.display = 'none';

  try {
    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 1200,
        system: 'ë‹¹ì‹ ì€ IVYÂ·EL Elingo ì˜ì–´ í•™ìŠµ ì½”ì¹˜ì˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•™ìƒì˜ ì˜ì–´ ê³¼ì œë¥¼ ê²€í† í•˜ê³  í”¼ë“œë°±ì„ JSONìœ¼ë¡œë§Œ ë°˜í™˜í•˜ì„¸ìš”. ë°˜ë“œì‹œ {"student":"...","coach":"..."} í˜•ì‹ë§Œ ë°˜í™˜í•˜ê³  ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ì“°ì§€ ë§ˆì„¸ìš”. student: ë¬¸ë²•êµì •+ìì—°ìŠ¤ëŸ¬ìš´í‘œí˜„ì œì•ˆ, í•œêµ­ì–´ì„¤ëª…+ì˜ì–´ì˜ˆë¬¸, ë”°ëœ»í•œ í†¤. coach: ì¹­ì°¬í¬ì¸íŠ¸+ë‹¤ìŒí•™ìŠµë°©í–¥, í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ.',
        messages: [{ role: 'user', content: 'í•™ìƒ: ' + studentName + ' / ê³¼ì œ: ' + hwTitle + '\n\n' + hwText }]
      })
    });

    // ìƒíƒœ ì½”ë“œë³„ ì—ëŸ¬ ì²˜ë¦¬
    if (response.status === 401) {
      localStorage.removeItem('ivyel_anthropic_key');
      updateApiKeyStatus();
      showError(errorEl, 'âŒ API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.\ní•˜ë‹¨ [API í‚¤ ë“±ë¡í•˜ê¸°]ì—ì„œ ë‹¤ì‹œ ë“±ë¡í•´ì£¼ì„¸ìš”.');
      btn.textContent = 'âœ¨ AI í”¼ë“œë°± ìƒì„±í•˜ê¸°'; btn.disabled = false;
      return;
    }
    if (response.status === 429) {
      showError(errorEl, 'â³ ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      btn.textContent = 'âœ¨ AI í”¼ë“œë°± ìƒì„±í•˜ê¸°'; btn.disabled = false;
      return;
    }
    if (!response.ok) {
      var errJson = await response.json().catch(function(){ return {}; });
      var errMsg = (errJson.error && errJson.error.message) ? errJson.error.message : ('HTTP ' + response.status);
      showError(errorEl, 'âŒ API ì˜¤ë¥˜: ' + errMsg);
      btn.textContent = 'âœ¨ AI í”¼ë“œë°± ìƒì„±í•˜ê¸°'; btn.disabled = false;
      return;
    }

    var data = await response.json();
    var raw = data.content[0].text.trim();

    // ë°±í‹± ì½”ë“œë¸”ë¡ ì œê±°
    raw = raw.replace(/^```json\s*/i,'').replace(/^```\s*/i,'').replace(/\s*```$/i,'').trim();

    var parsed;
    try {
      parsed = JSON.parse(raw);
    } catch(e) {
      // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì „ì²´ë¥¼ student íŒŒíŠ¸ë¡œ
      parsed = { student: raw, coach: '' };
    }

    document.getElementById('feedbackForStudent').textContent = parsed.student || '';
    document.getElementById('feedbackForCoach').textContent = parsed.coach || '';
    resultEl.style.display = 'block';
    resultEl.dataset.student = parsed.student || '';
    resultEl.dataset.coach = parsed.coach || '';

    btn.textContent = 'ğŸ”„ ë‹¤ì‹œ ìƒì„±';
    btn.disabled = false;
    document.getElementById('aiSendBtn').style.display = 'block';

  } catch(err) {
    console.error('AI í”¼ë“œë°± ì—ëŸ¬:', err);
    var msg = err.message || String(err);
    if (msg.includes('Failed to fetch') || msg.includes('NetworkError') || msg.toLowerCase().includes('cors')) {
      showError(errorEl, 'ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.\nê°€ëŠ¥í•œ ì›ì¸:\n1. ì¸í„°ë„· ì—°ê²° í™•ì¸\n2. CORS ì°¨ë‹¨ (ë¸Œë¼ìš°ì € ì½˜ì†” F12ì—ì„œ í™•ì¸)\n\nì—ëŸ¬: ' + msg);
    } else {
      showError(errorEl, 'âŒ ì˜¤ë¥˜: ' + msg);
    }
    btn.textContent = 'âœ¨ AI í”¼ë“œë°± ìƒì„±í•˜ê¸°';
    btn.disabled = false;
  }
}

function showError(el, msg) {
  if (!el) { alert(msg); return; }
  el.textContent = msg;
  el.style.display = 'block';
}

// â”€â”€ AI í”¼ë“œë°± Firestoreì— ì €ì¥ (í•™ìƒìš©/ì½”ì¹˜ìš© ë¶„ë¦¬) â”€â”€
async function sendAiFeedback(docId, studentName) {
  var resultEl = document.getElementById('aiFeedbackResult');
  var studentFeedback = resultEl.dataset.student;
  var coachNote = resultEl.dataset.coach;
  if (!studentFeedback) return;
  var sendBtn = document.getElementById('aiSendBtn');
  sendBtn.textContent = 'ì „ì†¡ ì¤‘...'; sendBtn.disabled = true;
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.updateDoc(mod.doc(window._db, 'homework', docId), {
      feedback: studentFeedback,   // í•™ìƒì—ê²Œ ë³´ì´ëŠ” í”¼ë“œë°±
      coachNote: coachNote,        // ì½”ì¹˜ë§Œ ë³´ëŠ” ë…¸íŠ¸
      feedbackAt: mod.serverTimestamp(),
      status: 'reviewed'
    });
    closeModal();
    showToast('âœ… ' + studentName + 'ë‹˜ê»˜ AI í”¼ë“œë°±ì„ ì „ì†¡í–ˆì–´ìš”!');
    loadCoachSubmissions();
  } catch(err) {
    showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
    sendBtn.textContent = 'ğŸ’Œ í•™ìƒì—ê²Œ ì „ì†¡í•˜ê¸°'; sendBtn.disabled = false;
  }
}

// â”€â”€ ì½”ì¹˜ ì§ì ‘ í”¼ë“œë°± ì‘ì„± â”€â”€
function openManualFeedbackModal(docId, studentName) {
  document.getElementById('modalTitle').textContent = 'âœï¸ ' + studentName + 'ë‹˜ê»˜ í”¼ë“œë°±';
  document.getElementById('modalBody').innerHTML = `
    <div style="font-size:.78rem;color:var(--gray);margin-bottom:.8rem;">ì§ì ‘ ì‘ì„±í•œ í”¼ë“œë°±ì´ í•™ìƒ ì•±ì— ë°”ë¡œ í‘œì‹œë¼ìš”</div>
    <textarea id="manualFbText" class="m-input" rows="5" placeholder="í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
    <button class="m-btn" onclick="sendManualFeedback('${docId}','${studentName}')">ì „ì†¡í•˜ê¸° â†’</button>`;
  document.getElementById('modalOverlay').classList.add('open');
}
async function sendManualFeedback(docId, studentName) {
  var text = document.getElementById('manualFbText').value.trim();
  if (!text) { showToast('í”¼ë“œë°± ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  try {
    var mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await mod.updateDoc(mod.doc(window._db, 'homework', docId), {
      feedback: text,
      feedbackAt: mod.serverTimestamp(),
      status: 'reviewed'
    });
    closeModal();
    showToast('âœ… ' + studentName + 'ë‹˜ê»˜ í”¼ë“œë°±ì„ ì „ì†¡í–ˆì–´ìš”!');
    loadCoachSubmissions();
  } catch(err) { showToast('ì „ì†¡ì— ì‹¤íŒ¨í–ˆì–´ìš”.'); }
}
</script>
</body>
</html>
